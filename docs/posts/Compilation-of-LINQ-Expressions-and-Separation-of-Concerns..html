

<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Peter Ritchie&#x27;s Blog - Compilation of LINQ Expressions and Separation of Concerns.</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/sass/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/sass/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/sass/ie8.css" /><![endif]-->
        

	</head>
	<body>

		<!-- Page Wrapper -->
			<div id="page-wrapper">
				
				<!-- Header -->
				<header id="header">
					<h1><a href="/">Peter Ritchie&#x27;s Blog</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

				<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>

						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>


    
<section id="banner">
  <div class="inner">
    <h2>Compilation of LINQ Expressions and Separation of Concerns.</h2>
            <p><em>Published on Tuesday, January 15, 2008</em></p>
                    <a role="button" href="/tags/January-2008" class="button small">January 2008</a>
                <a role="button" href="/tags/msmvps" class="button small">msmvps</a>
                <a role="button" href="/tags/Uncategorized" class="button small">Uncategorized</a>
  </div>
</section>

				<!-- Main -->
				<section id="wrapper">
					<section class="wrapper style2">
						<div class="inner">
							

<p><a href="http://blogs.msmvps.com/peterritchie/2008/01/15/compiled-linq-expressions-and-separation-of-concerns/" title="Permalink to Compilation of LINQ Expressions and Separation of Concerns.">Source</a></p>
<h1 id="compilation-of-linq-expressions-and-separation-of-concerns">Compilation of LINQ Expressions and Separation of Concerns.</h1>
<p>I was reading Rico Mariani's latest performance quiz (<a href="http://blogs.msdn.com/ricom/archive/2008/01/14/performance-quiz-13-linq-to-sql-compiled-query-cost-solution.aspx">#13</a>) involving compilation of LINQ expressions. One point that I got from his <a href="http://blogs.msdn.com/ricom/archive/2008/01/14/performance-quiz-13-linq-to-sql-compiled-query-cost-solution.aspx#7110594">comments</a> on the solution is that swapping to/from compiled queries is likely to cause the code to &quot;break even very easily&quot;. So, you end up making the decision to compile or not not based on observed metrics but:</p>
<ol>
<li><p>is there any re-use at all</p>
</li>
<li><p>how much uglier is the compiled code pattern and is the benefit worth the hassle</p>
</li>
</ol>
<p>Completely valid; and considering the savings you get, probably a fairly benign decision.</p>
<p>But, there's more object-oriented ways to approach this type of concern. My use of &quot;concern&quot; should give part of it away. The choice between whether an expression is compiled or not shouldn't be the concern of the method/class that is executing the LINQ expression. The Strategy Pattern is an object-oriented pattern the ensure abstraction, Separation of Concern, and the Single Responsibility Principle (and probably more). i.e. the choice between compilation or not is the responsibility of another class.</p>
<p>The Strategy Pattern can be implemented as a form of Inversion of Control or Dependency Injection. In this case we want to decouple the dependency on compiled/uncompiled LINQ statements from the method that executes it. The compiled/uncompiled strategy is injected into the class at construction or execution of the method and that class either makes (or made)the choice or acts as a proxy to execute the expression (compiling it first, with the compilation strategy).</p>
<p>Now, before I get too deep into doing this with a LINQ query (and you'll understand why in a bit) I'll show an example of implementing the Strategy Pattern.</p>
<p>One example of the Strategy Pattern involves choice of sorting techniques. Let's say we have an integer array that we need to sort, but how it is sorted needs to be runtime-selectable. We may do something like this:</p>
<pre><code> public interface ISortStrategy


 {


  void Sort(ref int[] data);


 }


 public class BubbleSort : ISortStrategy


 {


  public void Sort(ref int[] data)


  {


   //…


  }


 }


 public class HeapSort : ISortStrategy


 {


  public void Sort(ref int[] data)


  {


   //…


  }


 }
</code></pre>
<p>And an example of usingthese classes:</p>
<pre><code>  static void SortData(ref int[] data)


  {


   ISortStrategy sortStrategy = Configuration.Create&lt;ISortStrategy&gt;();


   sortStrategy.Sort(ref data);


  }
</code></pre>
<p>Fairly straightforward, SortData is now decoupled from the type of sort and is freely able to change by whatever means to be detected at runtime. Configuration.Create may make the decision whether to use BubbleSort or HeapSort based on something in app.config, something in user configuration settings, etc. The point is, SortData is not coupled to the instantiation of a particular sorting class.</p>
<p>Now, back to LINQ. The example queries that Rico presented were:</p>
<p>var q = (from o in nw.Orders</p>
<pre><code> select new

 {

  OrderID = o.OrderID,

  CustomerID = o.CustomerID,

  EmployeeID = o.EmployeeID,

  ShippedDate = o.ShippedDate

 }).Take(5);
</code></pre>
<p>And</p>
<p>var cq = CompiledQuery.Compile</p>
<p>(</p>
<pre><code>(Northwinds nw) =&gt;

  (from o in nw.Orders

  select new

  {

   OrderID = o.OrderID,

   CustomerID = o.CustomerID,

   EmployeeID = o.EmployeeID,

   ShippedDate = o.ShippedDate

  }).Take(5)
</code></pre>
<p>);</p>
<p>These queries make use of an anonymous type. In order to either compile &amp; execute this query or just execute a single query we need be able to declare a single query that can be compiled an executed. Unfortnately there's appears to be no way to do this. The call to CompiledQuery.Compile accept an Expression&lt;&gt; object and compiles it,</p>


<div id="disqus_thread"></div>  
<!--
    'Compilation-of-LINQ-Expressions-and-Separation-of-Concerns.'
    'Compilation of LINQ Expressions and Separation of Concerns.'
    'http://blog.peterritchie.com/posts/Compilation-of-LINQ-Expressions-and-Separation-of-Concerns.'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('1/15/2008');
    console.info('Compilation-of-LINQ-Expressions-and-Separation-of-Concerns.');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Compilation of LINQ Expressions and Separation of Concerns.';
    var disqus_url = 'http://blog.peterritchie.com/posts/Compilation-of-LINQ-Expressions-and-Separation-of-Concerns.';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Compilation-of-LINQ-Expressions-and-Separation-of-Concerns.';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</div>
					</section>
				
				</section>
				
				<!-- Footer -->
                <footer id="footer">
                    <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                    </p>
                </div>
        </div>
</div>
                </footer>
			</div>

		<!-- Scripts -->
			<script src="/assets/js/skel.min.js"></script>
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/util.js"></script>
            <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
            <script src="/assets/js/main.js"></script>

	</body>

</html>