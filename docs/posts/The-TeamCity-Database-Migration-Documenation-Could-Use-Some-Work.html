

<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Peter Ritchie&#x27;s Blog - The TeamCity Database Migration Documenation Could Use Some Work</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/sass/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/sass/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/sass/ie8.css" /><![endif]-->
        

	</head>
	<body>

		<!-- Page Wrapper -->
			<div id="page-wrapper">
				
				<!-- Header -->
				<header id="header">
					<h1><a href="/">Peter Ritchie&#x27;s Blog</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

				<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>

						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>


    
<section id="banner">
  <div class="inner">
    <h2>The TeamCity Database Migration Documenation Could Use Some Work</h2>
            <p><em>Published on Thursday, December 1, 2011</em></p>
                    <a role="button" href="/tags/December-2011" class="button small">December 2011</a>
                <a role="button" href="/tags/msmvps" class="button small">msmvps</a>
                <a role="button" href="/tags/Uncategorized" class="button small">Uncategorized</a>
  </div>
</section>

				<!-- Main -->
				<section id="wrapper">
					<section class="wrapper style2">
						<div class="inner">
							

<p><a href="http://blogs.msmvps.com/peterritchie/2011/12/01/the-teamcity-database-migration-documenation-could-use-some-work/" title="Permalink to The TeamCity Database Migration Documenation Could Use Some Work">Source</a></p>
<h1 id="the-teamcity-database-migration-documenation-could-use-some-work">The TeamCity Database Migration Documenation Could Use Some Work</h1>
<p>I have a client who wants all the benefits of <a href="http://bit.ly/taJxZg">ALM</a> but doesn't really want to spend the money on them. They're a start-up; so, I can respect that. As a result, I've been getting them up and running with some of the freely-available and open-source tools. They're also cross-platform, so getting on some of the great Microsoft programs like <a href="http://bit.ly/t4MS1w">BizSpark</a> and <a href="http://bit.ly/v5sCg5">WebsiteSpark</a> wasn't really in the cards.</p>
<p>Anywho… One of those tools was <a href="http://www.jetbrains.com/teamcity/">TeamCity</a>. It's a great too for Continuous Integration and Deployment. I've used it with a couple of clients now and have nothing but good things to say about it. When I installed it, I probably read some yellow box talking about <em>HSQLDB</em> and <em>External Database</em> and <em>evaluating the system</em> and <em>production</em>; but, honestly, just follow the steps. :). I created several configurations and had artifacts and build logs, so upgrading needed to include backup and restore… I had a couple spare cycles to look into migrating to an external database (as well as run through a backup/restore cycle) so I thought I might as well bite the bullet.</p>
<p>Well, the title of the post explains it. I'm not going to go too much into the <a href="http://bit.ly/rUhR9G">existing documentation</a> and how it jumps from page to page before you actually get a migration done; I'm just going to say there wasn't just a single list of steps (and, I think a couple things were missing). There's support for multiple platforms and multiple databases, so I get it's <em>hard</em>. It's seemed a bit too hard; so, I'm going to detail the process of migrating a TeamCity database to a SQL Server Express database here in case anyone else might find it useful.</p>
<p>[NOTE: I did this with TeamCity 6.5.4 build 18046, YMMV]</p>
<p>First off, <strong>backup</strong>. I did this from the web interface. I clicked on the <em>Administration</em> link near the top right, clicked the <em>Backup Data</em> link on the right-hand list, selected &quot;<em>Custom</em>&quot; scope and checked <em>everything</em>. This created a zip file in the backup directory in the <a href="http://bit.ly/vJCQjz">TeamCity data directory</a>. For me, this was C:TeamCity.BuildServerbackupTeamCity_Backup_20111130_210020.zip—but, yours will be different.</p>
<p>After doing a TeamCity backup, <strong>stop the TeamCity services</strong>. (Start menu, Control Panel, … you know the drill … or net stop TCBuildAgent and net stop TeamCity from a command prompt).</p>
<p>Next, I did a file system backup. I just copied the TeamCity directory to another folder. I had installed TeamCity to C:TeamCity. I think the default was my user folder; but, I'm only at my client for a limited time and when I'm gone that's going to cause a bit of grief (yeah, it happened :), so that meant copying C:TeamCity to somewhere else on C:. I've digressed from the the Jetbrains instructions already…</p>
<p>Next, I <strong>set up the external SQL Server Express database</strong>. I already had SQL Server 2005 Express installed, so, I won't go through that installation process. In <em>SQL Server Management Studio</em> I created a &quot;TeamCity&quot; database, and added a &quot;TeamCity&quot; login—you'll need those <em>later</em>.</p>
<p>Next, I <strong>installed some JDBC drivers for SQL Server</strong>. I just grabbed the Microsoft ones—the &quot;Native&quot; driver—I figured they might know a thing or two about writing a SQL Server driver. I downloaded from <a href="http://bit.ly/vZzMQr">here</a>. I unzipped (or ran the EXE) into a directory then copied the sqljdbc4.jar file into the libjdbc TeamCity data sub-directory (which was C:TeamCity.BuildServerlibJDBC for me).</p>
<p>Next, I <strong>configured TeamCity to use SQL Server</strong>. I created a database.properties file in the config data folder (C:TeamCity.BuildServerconfig, for me). It's <em>later</em>: the file was similar to:</p>
<p>connectionUrl=jdbc:sqlserver://localhost\sqlexpress:1433;databaseName=TeamCity<br />
connectionProperties.user=TeamCity<br />
connectionProperties.password=P&#64;nda$</p>
<p>…names and passwords might have been changed to protect the pandas. Since I'm using SQL Express I had to throw the \sqlexpress named-instance stuff in there. If you're using a different named instance, the&quot;sqlexpress&quot; part will be different. If you're using a &quot;real&quot; install of SQL Server, you don't need the &quot;\sqlexpress&quot; part at all, e.g. &quot;//localhost:1433&quot;. I also had to throw the :1433 stuff in there (long story), you may not need that.</p>
<p>At this point, be sure not to be running the TeamCity services and don't even think about logging into the TeamCity web interface (well, you can't if the server isn't running). As far as TeamCity is concerned at this point, you've got a fresh install. If you log in now it will ask you to create an Administrator login and create all the database tables. The next step requires an empty database and will <em>fail</em> if you do create that login…</p>
<p>Now, restore. Okay, I lied, this is one of those parts where the documentation has misled you. The restore requires that you have an empty config directory—i.e. you can't have database.properties in the config directory. You also need an empty system directory (CTeamCity.BuildServersystem for me)—a fresh install might mean those directories are empty, I don't know. I simply <strong>renamed config to config-old and system to system-old and created new config and system directories</strong>. <em>Then</em>, I had to <strong>add the Java bin directory to the PATH</strong>. TeamCity has all the Java binaries included with it—it doesn't actually install Java (oh, BTW, TeamCity uses Java). For me, I just ran path=%path%;c:TeamCityjrebin to let the command prompt know where java.exe is. If you have Java installed, you might not need to do this. <em>Then</em>, I performed a <strong>restore</strong>; which is just a matter of running maintainDB with the <em>restore</em> command from the TeamCity bin directory (C:TeamCitybin directory—note no &quot;.BuildServer&quot;—for me):</p>
<p>C:TeamCitybin&gt;maintainDB.cmd restore -F c:TeamCity.BuildServerbackupTeamCity_Backup_20111130_210020.zip -A c:TeamCity.BuildServer -T C:TeamCity.BuildServerconfig-olddatabase.properties</p>
<p>…which tells TeamCity to restore from my backup (zip) file, where the data directory is, and what database configuration to use (note the config-old business). Either TeamCity or Java doesn't grok relative directories; so, note that I used &quot;C:TeamCity&quot; instead of &quot;..&quot;.</p>
<p>Once the restore is done (and it's kind enough to remind you :), <strong>copy the database.properties file that you used to the config directory</strong> (for me, this was just copy ...BuildServerconfig-olddatabase.properties ...BuildServerconfig ).</p>
<p>Then, <strong>restart the TeamCity services</strong>:</p>
<p>C:TeamCitybin&gt;net start TCBuildAgent<br />
C:TeamCitybin&gt;net start TeamCity</p>
<p>And you're done. If you can now log into the TeamCity web interface with all your old logins and all your old configurations are still there… I did a bit of housework by deleting config-old, system-old, and went ahead and deleted the C:TeamCity copy that I made. (I don't need that, now that I've migrated to SQL Server and verified that everything works).</p>
<p><em>If</em> you ran into a problem along the way, you <em>could</em> simply copy the backed-up TeamCity directory over-top the old one (making sure the services were stopped first) and you <em>should</em> be back to where you were before. I didn't have a problem, so I can't confirm that actually works; but the docs <a href="http://bit.ly/s4fK4I">detail that it does</a>.</p>
<p>Since you have to have an empty database and empty config/system directories, I gather the actual restore process would be identical (minus dropping all the tables in the TeamCity SQL Server database).</p>


<div id="disqus_thread"></div>  
<!--
    'The-TeamCity-Database-Migration-Documenation-Could-Use-Some-Work'
    'The TeamCity Database Migration Documenation Could Use Some Work'
    'http://blog.peterritchie.com/posts/The-TeamCity-Database-Migration-Documenation-Could-Use-Some-Work'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('12/1/2011');
    console.info('The-TeamCity-Database-Migration-Documenation-Could-Use-Some-Work');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'The TeamCity Database Migration Documenation Could Use Some Work';
    var disqus_url = 'http://blog.peterritchie.com/posts/The-TeamCity-Database-Migration-Documenation-Could-Use-Some-Work';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'The-TeamCity-Database-Migration-Documenation-Could-Use-Some-Work';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</div>
					</section>
				
				</section>
				
				<!-- Footer -->
                <footer id="footer">
                    <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                    </p>
                </div>
        </div>
</div>
                </footer>
			</div>

		<!-- Scripts -->
			<script src="/assets/js/skel.min.js"></script>
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/util.js"></script>
            <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
            <script src="/assets/js/main.js"></script>

	</body>

</html>