

<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Peter Ritchie&#x27;s Blog - The Dispose Pattern as an anti-pattern</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/sass/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/sass/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/sass/ie8.css" /><![endif]-->
        

	</head>
	<body>

		<!-- Page Wrapper -->
			<div id="page-wrapper">
				
				<!-- Header -->
				<header id="header">
					<h1><a href="/">Peter Ritchie&#x27;s Blog</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

				<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>

						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>


    
<section id="banner">
  <div class="inner">
    <h2>The Dispose Pattern as an anti-pattern</h2>
            <p><em>Published on Sunday, January 20, 2013</em></p>
                    <a role="button" href="/tags/NET-Development" class="button small">.NET Development</a>
                <a role="button" href="/tags/AntiPattern" class="button small">AntiPattern</a>
                <a role="button" href="/tags/C%23" class="button small">C#</a>
                <a role="button" href="/tags/Design/Coding-Guidance" class="button small">Design/Coding Guidance</a>
                <a role="button" href="/tags/DevCenterPost" class="button small">DevCenterPost</a>
                <a role="button" href="/tags/January-2013" class="button small">January 2013</a>
                <a role="button" href="/tags/msmvps" class="button small">msmvps</a>
                <a role="button" href="/tags/Software-Development-Guidance" class="button small">Software Development Guidance</a>
  </div>
</section>

				<!-- Main -->
				<section id="wrapper">
					<section class="wrapper style2">
						<div class="inner">
							

<p><a href="http://blogs.msmvps.com/peterritchie/2013/01/20/the-dispose-pattern-as-an-anti-pattern/" title="Permalink to The Dispose Pattern as an anti-pattern">Source</a></p>
<h1 id="the-dispose-pattern-as-an-anti-pattern">The Dispose Pattern as an anti-pattern</h1>
<p>When .NET first came out, the framework only had abstractions for what seemed like a handful of Windows features. Developers were required to write their own abstractions around the Windows features that did not have abstractions. Working with these features required you to work with unmanaged resources in many instances. Unmanaged resources, as the name suggests, are not managed in any way by the .NET Framework. If you don't free those unmanaged resources when you're done with them, they'll leak. Unmanaged resources need attention and they need it differently from managed resources. Managed resources, by definition, are managed by the .NET Framework and their resources will be freed automatically a great proportion of the time when they're no longer in use. The Garbage Collector (GC) knows (or is &quot;told&quot;) what objects are in use and what objects are not in use.</p>
<p>The GC frees managed resources when it gets its timeslice(s) to tidy up memory—which will be some time <em>after</em> the resource stop being used. The IDisposable interface was created so that managed resources can be deterministically freed. I say &quot;managed resources&quot; because interfaces can do nothing with destructors and thus the interface inherently can't do anything specifically to help with unmanaged resources.</p>
<p>&quot;Unmanaged resources&quot; generally means dealing with a handle and freeing that handle when no longer in use. &quot;Support&quot; for Windows features in .NET abstractions generally involved freeing those handles when not in use. Much like managed resources, to deterministically free them you had to implement IDisposable and free them in the call to Dispose. The problem with this was if you forgot to wrap the object in a using block or otherwise didn't call Dispose. The managed resources would be detected as being unused (unreferenced) and be freed automatically at the next collection, unmanaged resources would not. Unmanaged resources would leak and could cause potential issues with Windows in various ways (handles are a finite resource, for one, so an application could &quot;run out&quot;). So, those unmanaged resources must be freed during finalization of the object (the automatic cleanup of the object during collection by the GC) had they not already been freed during dispose. Since finalization and Dispose are intrinsically linked, the Dispose Pattern was created to make this process easier and consistent.</p>
<p>I won't get into much detail about the Dispose Pattern, but what this means is that to implement the Dispose Pattern, you must implement a destructor that calls Dispose(bool) with a false argument. Destructors that do no work force an entry to be made in the finalize queue for each instance of that type. This forces the type to use its memory until the GC has a chance to collect and run finalizers. This impacts performance (needless finalization) as well as adds stress to the garbage collector (extra work, more things to keep track of, extra resources, etc.). <a href="http://blogs.jetbrains.com/dotnet/2013/01/r2p-a-general-purpose-resharper-plugin/">1</a> If you have no unmanaged resources to free, you have no reason to have a destructor and thus have no reason to implement the Dispose Pattern. Some might say it's handy &quot;just in case&quot;; but those cases are <em>really rare</em>.</p>
<p>.NET has evolved quite a bit from version 1.x, it how has rich support for many of the Windows features that people need to be able to use. Most of the type handles are hidden in these feature abstractions and the developer doesn't need to do anything special other than recognize a type implements IDisposable and deterministically call Dispose in some way. Of the features that didn't have abstractions, lower-level abstractions like SafeHandle (which SafeHandleZeroOrMinusOneIsInvalid and SafeHandleMinuesOneIsInvalid etc. derive from)—which implement IDisposable and makes every native handle a &quot;managed resource&quot;—means <strong>there is very little reason to write a destructor</strong>.</p>
<p>The most recent perpetuation of the anti-pattern is in a Resharper extension called <a href="http://blogs.jetbrains.com/dotnet/2013/01/r2p-a-general-purpose-resharper-plugin/">R2P</a> (refactoring to patterns). Let's analyze the example R2P IDisposable code:</p>
<p><img src="http://blogs.jetbrains.com/dotnet/wp-content/uploads/2012/12/71.png" class="img-fluid" alt="" /></p>
<p>As we can see from this code, the Dispose pattern has been implemented and a destructor with a Dispose(false). If we look at Dispose(bool), <strong>Dispose(bool) does nothing if a false argument is passed to it</strong>. So, effectively we could simply remove Dispose(false) and get the same result. This also means we could completely remove the destructor. Now we're left with Dispose(true) in Dispose() and Dispose(bool). Since Dispose(bool) is now only ever called with a true argument, there's no reason to have this method. We can take the contents of the if(disposing) block, move it to Dispose (replacing the Dispose(true)) and have exactly the same result as before <strong>without the Dispose Pattern</strong>. Except now, we're reduced the stress on the GC <em>and</em> we've made our code much less complex. Also, since we no longer have a destructor there will be no finalizer, so there's no need to call SuppressFinalize. <strong>Not implementing the Dispose Pattern would result in better code</strong> in this case:</p>
<pre><code>	publicclassPerson : IDisposable
	{
		publicvoid Dispose()
		{
			Photo.Dispose();
		}
 
		publicBitmap Photo { get; set; }
	}
</code></pre>
<p>Of course, when you're <strong>deriving from a class that implements the Dispose Pattern</strong> <em>and your class needs to dispose of managed resources</em>, then you need to make use of Dispose(bool). For example:</p>
<pre><code>	publicclassFantasicalControl : System.Windows.Forms.Control
	{
		protectedoverridevoid Dispose(bool disposing)
		{
			if(disposing)
			{
				Photo.Dispose();
			}
			base.Dispose(disposing);
		}
		publicBitmap Photo { get; set; }
	}
</code></pre>
<p>Patterns are great, they help document code by providing consistent terminology and recognizable implementation (code). But, when they're not used in the right place at the right time, they make code confusing and harder to understand and become Anti-Patterns.</p>
<p><a href="http://blogs.jetbrains.com/dotnet/2013/01/r2p-a-general-purpose-resharper-plugin/">1</a> <a href="http://bit.ly/YbBDAR">http://bit.ly/YbBDAR</a></p>


<div id="disqus_thread"></div>  
<!--
    'The-Dispose-Pattern-as-an-anti-pattern'
    'The Dispose Pattern as an anti-pattern'
    'http://blog.peterritchie.com/posts/The-Dispose-Pattern-as-an-anti-pattern'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('1/20/2013');
    console.info('The-Dispose-Pattern-as-an-anti-pattern');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'The Dispose Pattern as an anti-pattern';
    var disqus_url = 'http://blog.peterritchie.com/posts/The-Dispose-Pattern-as-an-anti-pattern';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'The-Dispose-Pattern-as-an-anti-pattern';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</div>
					</section>
				
				</section>
				
				<!-- Footer -->
                <footer id="footer">
                    <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                    </p>
                </div>
        </div>
</div>
                </footer>
			</div>

		<!-- Scripts -->
			<script src="/assets/js/skel.min.js"></script>
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/util.js"></script>
            <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
            <script src="/assets/js/main.js"></script>

	</body>

</html>