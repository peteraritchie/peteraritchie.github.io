

<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Peter Ritchie&#x27;s Blog - Thread synchronization of atomic invariants in .NET 4.5 clarifications</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/sass/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/sass/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/sass/ie8.css" /><![endif]-->
        

	</head>
	<body>

		<!-- Page Wrapper -->
			<div id="page-wrapper">
				
				<!-- Header -->
				<header id="header">
					<h1><a href="/">Peter Ritchie&#x27;s Blog</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

				<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>

						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>


    
<section id="banner">
  <div class="inner">
    <h2>Thread synchronization of atomic invariants in .NET 4.5 clarifications</h2>
            <p><em>Published on Monday, September 10, 2012</em></p>
                    <a role="button" href="/tags/NET-45" class="button small">.NET 4.5</a>
                <a role="button" href="/tags/NET-Development" class="button small">.NET Development</a>
                <a role="button" href="/tags/Concurrency" class="button small">Concurrency</a>
                <a role="button" href="/tags/DevCenterPost" class="button small">DevCenterPost</a>
                <a role="button" href="/tags/msmvps" class="button small">msmvps</a>
                <a role="button" href="/tags/Multithreaded" class="button small">Multithreaded</a>
                <a role="button" href="/tags/September-2012" class="button small">September 2012</a>
                <a role="button" href="/tags/Software-Development-Guidance" class="button small">Software Development Guidance</a>
  </div>
</section>

				<!-- Main -->
				<section id="wrapper">
					<section class="wrapper style2">
						<div class="inner">
							

<p><a href="http://blogs.msmvps.com/peterritchie/2012/09/10/thread-synchronization-of-atomic-invariants-in-net-4-5-clarifications/" title="Permalink to Thread synchronization of atomic invariants in .NET 4.5 clarifications">Source</a></p>
<h1 id="thread-synchronization-of-atomic-invariants-in.net-4.5-clarifications">Thread synchronization of atomic invariants in .NET 4.5 clarifications</h1>
<p>In <a href="http://blogs.msmvps.com/blogs/peterritchie/archive/2012/09/09/thread-synchronization-of-atomic-invariants-in-net-4-5.aspx">Thread synchronization of atomic invariants in .NET 4.5</a> I'm presenting my observations of what the compiler does in very narrow context of only on Intel x86 and Intel x64 with a particular version of .NET. You can install SDKs that give you access to compilers to other processors. For example, if you write something for Windows Phone or Windows Store, you'll get compilers for other processors (e.g. ARM) with memory models looser than x86 and x64. That post was only observations in the context of x86 and x64.</p>
<p>I believe more knowledge is always better; but you have to use that knowledge responsibly. If you know you're only ever going to target x86 or x64 (and you don't if you use AnyCPU even in VS 2012 because some yet-to-be-created processor might be supported in a future version or update to .NET) and you <em>do want to micro-optimize your code</em>, then that post might give you enough knowledge to do that. Otherwise, take it with a grain of salt. I'll get into a little bit more detail in part 2: Thread synchronization of non-atomic invariants in .NET 4.5 at a future date—which will include more specific guidance and recommendations.</p>
<p>In the case were I used a <em>really awkwardly placed</em> lock:</p>
<pre><code>   1: var lockObject = new object();


   2: while (!complete)


   3: {


   4:     lock(lockObject)


   5:     {


   6:         toggle = !toggle;


   7:     }


   8: }
</code></pre>
<p>It's important to point out the degree of implicit side-effects that this code depends on. One, it assumes that the compiler is smart enough to know that a while loop is the equivalent of a series of sequential statements. e.g. this is effectively equivalent to:</p>
<pre><code>   1: var lockObject = new object();


   2: if (complete == false) return;


   3: lock (lockObject)


   4: {


   5:     toggle = !toggle;


   6: }


   7: if (complete == false) return;


   8: lock (lockObject)


   9: {


  10:     toggle = !toggle;


  11: }


  12: //...
</code></pre>
<p>That is, there is the implicit volatile read (e.g. a memory fence, from the Monitor.Enter implementation detail) at the start of the lock block and an implicit volatile write (e.g. a memory fence, from the Monitor.Exit implementation detail).</p>
<p>In case it wasn't obvious, you should <strong>never write code like</strong> this, it's simply an example—and as I pointed out in the original post, it's confusing to anyone else reading it: lockObject can't be shared amongst threads and the lock block really isn't protecting toggle and can/likely to get &quot;maintained&quot; into something that no longer works.</p>
<p>In the same grain, the same can be said for the original example of this code:</p>
<pre><code>   1: static void Main()


   2: {


   3:   bool complete = false; 


   4:   var t = new Thread (() =&gt;


   5:   {


   6:     bool toggle = false;


   7:     while (!complete)


   8:     {


   9:         Thread.MemoryBarrier();


  10:         toggle = !toggle;


  11:     }


  12:   });


  13:   t.Start();


  14:   Thread.Sleep (1000);


  15:   complete = true;


  16:   t.Join();


  17: }
</code></pre>
<p>While this code works, it's not apparently clear that the Thread.MemoryBarrier() is there so that our read of complete (and not toggle) isn't optimized into a registry read. Regardless of the degree you might be able to depend on the compiler continuing to do this is up to you. The code is equally as valid and more clear if written to use Thread.VolatileRead, except for the fact that Thread.VolatileRead does not support the Boolean type. It can be re-written using Int32 instead. For example:</p>
<pre><code>   1: static void Main(string[] args)


   2: {


   3:   int complete = 0; 


   4:   var t = new Thread (() =&gt;


   5:   {


   6:     bool toggle = false;


   7:     while (Thread.VolatileRead(ref complete) == 0)


   8:     {


   9:         toggle = !toggle;


  10:     }


  11:   });


  12:   t.Start();


  13:   Thread.Sleep (1000);


  14:   complete = 1; // CORRECTION from 0


  15:   t.Join();


  16: }
</code></pre>
<p>Which is more clear and shows your intent more explicitly.</p>


<div id="disqus_thread"></div>  
<!--
    'Thread-synchronization-of-atomic-invariants-in-.NET-4.5-clarifications'
    'Thread synchronization of atomic invariants in .NET 4.5 clarifications'
    'http://blog.peterritchie.com/posts/Thread-synchronization-of-atomic-invariants-in-.NET-4.5-clarifications'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('9/10/2012');
    console.info('Thread-synchronization-of-atomic-invariants-in-.NET-4.5-clarifications');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Thread synchronization of atomic invariants in .NET 4.5 clarifications';
    var disqus_url = 'http://blog.peterritchie.com/posts/Thread-synchronization-of-atomic-invariants-in-.NET-4.5-clarifications';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Thread-synchronization-of-atomic-invariants-in-.NET-4.5-clarifications';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</div>
					</section>
				
				</section>
				
				<!-- Footer -->
                <footer id="footer">
                    <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                    </p>
                </div>
        </div>
</div>
                </footer>
			</div>

		<!-- Scripts -->
			<script src="/assets/js/skel.min.js"></script>
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/util.js"></script>
            <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
            <script src="/assets/js/main.js"></script>

	</body>

</html>