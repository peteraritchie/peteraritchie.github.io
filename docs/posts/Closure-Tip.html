

<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Peter Ritchie&#x27;s Blog - Closure Tip</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/sass/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/sass/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/sass/ie8.css" /><![endif]-->
        

	</head>
	<body>

		<!-- Page Wrapper -->
			<div id="page-wrapper">
				
				<!-- Header -->
				<header id="header">
					<h1><a href="/">Peter Ritchie&#x27;s Blog</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

				<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>

						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>


    
<section id="banner">
  <div class="inner">
    <h2>Closure Tip</h2>
            <p><em>Published on Monday, October 27, 2008</em></p>
                    <a role="button" href="/tags/msmvps" class="button small">msmvps</a>
                <a role="button" href="/tags/October-2008" class="button small">October 2008</a>
                <a role="button" href="/tags/Uncategorized" class="button small">Uncategorized</a>
  </div>
</section>

				<!-- Main -->
				<section id="wrapper">
					<section class="wrapper style2">
						<div class="inner">
							

<p><a href="http://blogs.msmvps.com/peterritchie/2008/10/27/closure-tip/" title="Permalink to Closure Tip">Source</a></p>
<h1 id="closure-tip">Closure Tip</h1>
<p>In C# 2 and greater you have the ability to write closures. A closure is a function that is evaluated in an environment containing one ore more bound variables[1]. In C# 2 this is done by creating an anonymous method that accesses a variable declared outside the body of the anonymous method. Writing closures (which can evolve from an anonymous method that is not a closure) must be very deliberate and must be given great attention. Closures offer a very specific way of essentially creating code at runtime based on runtime values. But, with closures, they can be bound to a mutable variable. When you bind to a mutable variable you get the value of the variable when the closure is run, not when the closure was created. You intuitively expect to get the value when the closure was created, not when it was executed. For example</p>
<pre><code> String[] numbers = new[] {&quot;one&quot;, &quot;two&quot;, &quot;three&quot;};


 List&lt;MethodInvoker&gt; delegates = new List&lt;MethodInvoker&gt;();


 foreach(String number in numbers)


 {


 delegates.Add(delegate() { Trace.WriteLine(number); });


 }


 //...


 foreach(MethodInvoker method in delegates)


 {


 method();


 }
</code></pre>
<p>With this code, you would expect the following trace:</p>
<p>one<br />
two<br />
three</p>
<p>But, you get this:</p>
<p>three<br />
three<br />
three</p>
<p>This is because the anonymous method is bound to the variable <em>number</em> which was &quot;three&quot; when the anonymous method was executed.</p>
<p>But, what can you do to create an anonymous method at runtime that will output the value of a specific value in a collection? Well, the answer is very simple, bind to a variable that doesn't change. For example:</p>
<pre><code> foreach (String number in numbers)


 {


 String text = number;


 delegates.Add(delegate() { Trace.WriteLine(text); });


 }


 foreach (MethodInvoker method in delegates)


 {


 method();


 }
</code></pre>
<p>The addition of the <em>text</em> variable that is simply initialized with the value of <em>number</em> means the closure isn't bound to a mutating variable and end up getting results that are more intuitive:</p>
<p>one<br />
two<br />
three</p>
<p>In C# 3 you also have the ability to write closures in the form of lambdas. You could do the same as the above with lambdas as follows:</p>
<pre><code> foreach (String number in numbers)


 {


 String text = number;


 delegates.Add(() =&gt; Trace.WriteLine(text));


 }


 foreach (MethodInvoker method in delegates)


 {


 method();


 }
</code></pre>
<p>Related advice may be found in Item 33 of Bill Wagner's <em>More Effective C#</em>.</p>
<p>With Resharper you get an added warning that warns you that you're accessing a modified closure. So, in the first example, the IDE would show <em>number</em> as the WriteLine parameter as a warning.</p>
<p>[1] <a href="http://en.wikipedia.org/wiki/Lexical_closure">http://en.wikipedia.org/wiki/Lexical_closure</a></p>


<div id="disqus_thread"></div>  
<!--
    'Closure-Tip'
    'Closure Tip'
    'http://blog.peterritchie.com/posts/Closure-Tip'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('10/27/2008');
    console.info('Closure-Tip');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Closure Tip';
    var disqus_url = 'http://blog.peterritchie.com/posts/Closure-Tip';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Closure-Tip';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</div>
					</section>
				
				</section>
				
				<!-- Footer -->
                <footer id="footer">
                    <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                    </p>
                </div>
        </div>
</div>
                </footer>
			</div>

		<!-- Scripts -->
			<script src="/assets/js/skel.min.js"></script>
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/util.js"></script>
            <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
            <script src="/assets/js/main.js"></script>

	</body>

</html>