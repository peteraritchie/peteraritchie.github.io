

<!DOCTYPE HTML>
<!--
	Solid State by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Peter Ritchie&#x27;s Blog - ITSWITCH #1: Answer</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="/assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="/assets/sass/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="/assets/sass/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="/assets/sass/ie8.css" /><![endif]-->
        

	</head>
	<body>

		<!-- Page Wrapper -->
			<div id="page-wrapper">
				
				<!-- Header -->
				<header id="header">
					<h1><a href="/">Peter Ritchie&#x27;s Blog</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

				<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>

						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>


    
<section id="banner">
  <div class="inner">
    <h2>ITSWITCH #1: Answer</h2>
            <p><em>Published on Monday, July 28, 2008</em></p>
                    <a role="button" href="/tags/NET-20" class="button small">.NET 2.0</a>
                <a role="button" href="/tags/NET-Development" class="button small">.NET Development</a>
                <a role="button" href="/tags/C%23" class="button small">C#</a>
                <a role="button" href="/tags/Design/Coding-Guidance" class="button small">Design/Coding Guidance</a>
                <a role="button" href="/tags/ITSWITCH-Answer" class="button small">ITSWITCH Answer</a>
                <a role="button" href="/tags/July-2008" class="button small">July 2008</a>
                <a role="button" href="/tags/msmvps" class="button small">msmvps</a>
                <a role="button" href="/tags/Pop-Quiz" class="button small">Pop Quiz</a>
                <a role="button" href="/tags/Software-Development" class="button small">Software Development</a>
  </div>
</section>

				<!-- Main -->
				<section id="wrapper">
					<section class="wrapper style2">
						<div class="inner">
							

<p><a href="http://blogs.msmvps.com/peterritchie/2008/07/28/itswitch-1-answer/" title="Permalink to ITSWITCH #1: Answer">Source</a></p>
<h1 id="itswitch-1-answer">ITSWITCH #1: Answer</h1>
<p><a href="http://blogs.msmvps.com/blogs/peterritchie/archive/2008/07/25/itswitch-1.aspx">Last post</a> I detailed some code that may or may not have something wrong in it. If you thought InitializeOne and IntializeTwo are semantically identical (e.g. they differ only by performance), you'd be wrong.</p>
<p>If you simply ran the code, you'd be able to guess where the problem is. To understand what's causing the problem. Let's look at how C# effectively implements the two loops.</p>
<p>InitializeOne is essentially equivalent to</p>
<pre><code> private class PrivateDelegateHelper


 {


 public String Value { get; set; }


 public void Method()


 {


 TestClass.ProcessText(Value);


 }


 }





 public void InitializeThree(String[] strings)


 {


 delegates = new List&lt;MethodInvoker&gt;(strings.Length);


 MethodInvoker cachedAnonymousDelegate = null;


 PrivateDelegateHelper privateDelegateHelper = new PrivateDelegateHelper();


 String[] copyOfStrings = strings;


 for(int i = 0; i &lt; copyOfStrings.Length; ++i)


 {


 privateDelegateHelper.Value = copyOfStrings[i];


 if (cachedAnonymousDelegate == null)


 {


 cachedAnonymousDelegate = new MethodInvoker(privateDelegateHelper.Method);


 }


 delegates.Add(cachedAnonymousDelegate);


 }


 }
</code></pre>
<p>Now it's obvious, right?</p>
<p>For those you don't want to read all the code, the problem is that only one PrivateDelegateHelper object is instantiated and its value property is set in each iteration of the loop. Because the delegates aren't run until sometime after the loop, they're all run with the last value of the string array as their argument.</p>
<p>The technical term for what we've implemented here is a <a href="http://en.wikipedia.org/wiki/Closure_(computer_science)">closure</a>. If you're using Resharper 4.x, you would have noticed a warning &quot;Access to modified closure&quot;:</p>
<p><img src="http://blogs.msmvps.com/cfs-filesystemfile.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/peterritchie/modified-closure.JPG" class="img-fluid" alt="" /></p>
<p>…which is attempting to tell you that the closure (the delegate and cached bound variables) has changed (in this case one of the bound variables has changed between the creation of a closure and another and out expected output is effected).</p>
<p>By the way, you can get the same thing with C# 3+ with lambdas (i.e. you can also write closures with lambdas):</p>
<pre><code> public void InitializeOne(String[] strings)


 {


 delegates = new List&lt;MethodInvoker&gt;(strings.Length);


 for (int i = 0; i &lt; strings.Length; ++i)


 {


 String value = strings[i];


 delegates.Add(() =&gt; ProcessText(value));


 }


 }





 public void InitializeTwo(String[] strings)


 {


 delegates = new List&lt;MethodInvoker&gt;(strings.Length);


 foreach(String value in strings)


 {


 delegates.Add(() =&gt; ProcessText(value));


 }


 }
</code></pre>


<div id="disqus_thread"></div>  
<!--
    'ITSWITCH-%231%3A-Answer'
    'ITSWITCH #1: Answer'
    'http://blog.peterritchie.com/posts/ITSWITCH-%231%3A-Answer'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('7/28/2008');
    console.info('ITSWITCH-%231%3A-Answer');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'ITSWITCH #1: Answer';
    var disqus_url = 'http://blog.peterritchie.com/posts/ITSWITCH-%231%3A-Answer';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'ITSWITCH-%231%3A-Answer';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</div>
					</section>
				
				</section>
				
				<!-- Footer -->
                <footer id="footer">
                    <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                    </p>
                </div>
        </div>
</div>
                </footer>
			</div>

		<!-- Scripts -->
			<script src="/assets/js/skel.min.js"></script>
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/util.js"></script>
            <!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
            <script src="/assets/js/main.js"></script>

	</body>

</html>