
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - Robustness with RabbitMQ in .NET</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - Robustness with RabbitMQ in .NET" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/Robustness-with-RabbitMQ-in-.NET" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Robustness with RabbitMQ in .NET</h1>
    <div class="meta">        
Published on Sunday, May 22, 2011<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/May-2011" class="btn btn-default btn-xs">May 2011</a>
                    <a role="button" href="/tags/Message-Oriented-Architectures" class="btn btn-default btn-xs">Message-Oriented Architectures</a>
                    <a role="button" href="/tags/RabbitMQ" class="btn btn-default btn-xs">RabbitMQ</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://blogs.msmvps.com/peterritchie/2011/05/22/robustness-with-rabbitmq-in-net/" title="Permalink to Robustness with RabbitMQ in .NET">Source</a></p>
<h1 id="robustness-with-rabbitmq-in.net">Robustness with RabbitMQ in .NET</h1>
<p>Recently I've been doing a bit of work with queues, in part with RabbitMQ.</p>
<p>Unfortunately, (or fortunately, depending on your point of view) network connections where I am have had a tendency to be unreliable. That's a story for the pub; but, needless to say we needed our clients of RabbitMQ to be robust in light of disconnections. Fortunately, RabbitMQ has ways of dealing with this.</p>
<h5 id="a-bit-about-queues">A bit about queues</h5>
<p>Queues are a two way communication mechanism. You can enqueue messages and dequeue messages. In a distributed system you often have a local queue that you asynchronously deal with when you enqueue and dequeue messages. MSMQ works in this way. RabbitMQ can be used in this way too. Eventually, though, a connection to a remote computer needs to be made for the message to be delivered or received from the queue. RabbitMQ can support asynchronous communications; which means failure can occur outside of when you give your message to the local queue (or &quot;client&quot;, in RabbitMQ parlance) or receive a message from the local queue. RabbitMQ doesn't have the luxury of a the OS having a built-in queue client like MSMQ to deal with connection issues out-of-process—the RabbitMQ client is in-process to your application, so it can be a bit tricky dealing with disconnections.</p>
<p>RabbitMQ supports many &quot;patterns&quot; of messaging like pub/sub, push/pull, etc. I've been working in a more pub/sub model; so I'm focusing on publication and subscription aspects of RabbitMQ</p>
<p>Robustness can be a complex beast; and I'm not going to discuss many of the aspects certain systems need to deal with. I'm going to take the stance that the queue and it's client API deals with correct delivery, receipt, acknowledgement, and resending of unacknowledged messages.</p>
<p>With that said, I've alluded to two points of failure. During the enqueue or during the dequeue. This is where I'll detail how we can make our system to be more robust with regard to RabbitMQ and disconnections. With a subscription model in RabbitMQ, the local queue client basically proactively gathers messages for you and places them in a local cache (itself a queue) and you &quot;enumerate&quot; through the messages in the queue. One way of doing this is with the Subscrption.Next() method. One overload of Next simply blocks and returns the next message in the queue. In my circumstance we simply couldn't block the thread indeterminately like that, so we used a different overload Subscription.Next(int timeout, out BasicDeliveryEventArgs result). This is effectively the same as the first Next method but will timeout if there are no messages in the queue. The calling code is then free to do anything else it needs to do, like abort and/or try again. During the call to Next the connection to the queue server could have been severed. If it has been severed one of two things will happen.</p>
<p>In the case of Next(int, BasicDeliveryEventArgs), the BasicDeliveryEventArgs instance may be null but Next will return true. (i.e. &quot;succeeded&quot; but there's no message). This may happen because the connection was lost prior to the call to Next. This may also happen if the connection is severed while data is being streamed from the server—resulting internally with an end of stream exception.</p>
<p>Another possibility is OperationInterruptedException will be thrown from Subscription.Next. I'm not sure why things like end of stream exceptions aren't translated into an OperationInterruptedException instead of returning true and setting BaiscDeliveryEventArgs to null.</p>
<p>In either case, this tells you that the connection is no longer good. With RabbitMQ you have to try to recreate your connection and try your dequeue again.</p>
<p>Of course, you're not sure what the problem may be and thus don't know when the server may be available again; so, to simply immediately try to reconnect and retry will most likely mean several failures until it succeeds. e.g. if the server was rebooted due to an update; we might be able to try thousands of times before we're successful. To avoid these needless retries, adding a delay in there limits the number of times we retry and gives other threads a chance at CPU time. I've found that when we don't delay at all, it's more common that we never seem to be able to reconnect.</p>
<p>Following is some code that deals with disconnections in a robust way.</p>
<pre><code>while (!abort)
{


	if (subscription == null)
	{
		try
		{
			subscription = CreateSubscription(connectionFactory, &quot;mainqueue&quot;, out connection, out model);
		}
		catch (BrokerUnreachableException)
		{
			Thread.Sleep(1000);
			continue;
		}
	}
	try
	{
		BasicDeliverEventArgs basicDeliveryEventArgs;
		if (subscription.Next(500, out basicDeliveryEventArgs))
		{
			if (basicDeliveryEventArgs == null)
			{
				thrownewOperationInterruptedException(
					newShutdownEventArgs(ShutdownInitiator.Application, 0, &quot;null BasicDeliveryEventArgs&quot;));
			}
			// **TODO: something with basicDeliveryEventArgs.Body**
			subscription.Ack(basicDeliveryEventArgs);
		}
	}
	catch (OperationInterruptedException)
	{
		// don't bother with connection, it will throw IOException due to disconnection
		using (model) using (subscription)
		{
			subscription = null;
			model = null;
			connection = null;
		}
		Thread.Sleep(1000);
	}
</code></pre>
<p>}</p>
<p>It, of course, doesn't go into detail about how to create a subscription instance—I've left that up to you to create a subscription how your application needs it, and the disposal of the model and the connection isn't detailed as your application will implement this code in different ways influencing when and how these two instances need to be disposed.</p>


<div id="disqus_thread"></div>  
<!--
    'Robustness-with-RabbitMQ-in-.NET'
    'Robustness with RabbitMQ in .NET'
    'http://blog.peterritchie.com/posts/Robustness-with-RabbitMQ-in-.NET'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('5/22/11');
    console.info('Robustness-with-RabbitMQ-in-.NET');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Robustness with RabbitMQ in .NET';
    var disqus_url = 'http://blog.peterritchie.com/posts/Robustness-with-RabbitMQ-in-.NET';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Robustness-with-RabbitMQ-in-.NET';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2025
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>&nbsp;|&nbsp;<a rel="me" href="https://bsky.app/profile/peterritchie.com">Bluesky</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

