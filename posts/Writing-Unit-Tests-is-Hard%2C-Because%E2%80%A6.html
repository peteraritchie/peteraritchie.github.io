
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - Writing Unit Tests is Hard, Because&#x2026;</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - Writing Unit Tests is Hard, Because&#x2026;" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/Writing-Unit-Tests-is-Hard%2C-Because%E2%80%A6" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Writing Unit Tests is Hard, Because&#x2026;</h1>
    <div class="meta">        
Published on Tuesday, March 10, 2015<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/March-2015" class="btn btn-default btn-xs">March 2015</a>
                    <a role="button" href="/tags/Uncategorized" class="btn btn-default btn-xs">Uncategorized</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://pr-blog.azurewebsites.net/2015/03/10/writing-unit-tests-is-hard-because/" title="Permalink to Writing Unit Tests is Hard, Because…">Source</a></p>
<h1 id="writing-unit-tests-is-hard-because">Writing Unit Tests is Hard, Because…</h1>
<p><img src="http://pr-blog.azurewebsites.net/wp-content/uploads/2015/03/hardwork_thumb.png" class="img-fluid" alt="hard-work" title="hard-work" /> There are lots of things in life that are hard. There is also lots of things in life that we make hard for ourselves when we don't have to. Unit testing is one of those things that we've made hard for ourselves and we don't have do.</p>
<p>Before I go into not making unit testing harder than it needs to be, let me first talk about accidental complexity. Fred Brooks details two types of complexity in his book <em>No Silver Bullet – Essence and Accidents of Software Engineering</em>: <strong>Essential Complexity</strong> and <strong>Accidental Complexity</strong>. Essential complexity is complexity inherent in the problem. Accidental complexity is the complexity engineers add in an effort to solve a problem. Essential complexity cannot be avoided, accidental complexity can.</p>
<p>So, how does this apply to unit testing? Well, when unit testing is hard it is an indication that there is unnecessary coupling. If you can't test a controller without the model that accesses the database (and thus an RDMS, an instance of the database, test data, etc.) then you have accidental complexity that hinders your ability to test. There are ways to design software and structure code such that a controller can be composed at run-time and interact with abstractions so that the uniqueness of the controller (or the value-add) can be tested independently. Because we <em>can</em> design this way, anything that hinders fine-grained testing is accidental complexity, by definition.</p>
<p>Dealing with this accidental complexity with unit tests is straightforward, but requires thinking about design. Changing a design to remove the accidental complexity is <em>doable</em>, but not adding the accidental complexity at all is <em>preferable</em>. TDD helps a lot with that; but that's for another post—the focus of this post will be about changing design, or <em>removing</em> accidental complexity.</p>
<p>Removing accidental complexity is really about decoupling. Two of the most useful techniques for creating a decoupled design are the <strong>Dependency Injection pattern</strong> and the <strong>Dependency Inversion Principle</strong>.</p>
<p>The Dependency Inversion Principle (DIP) states:</p>
<blockquote class="blockquote">
<ol type="A">
<li><p>HIGH LEVEL MODULES SHOULD NOT DEPEND UPON LOW LEVEL MODULES. BOTH SHOULD DEPEND UPON ABSTRACTIONS.</p>
</li>
<li><p>ABSTRACTIONS SHOULD NOT DEPEND UPON DETAILS. DETAILS SHOULD DEPEND UPON ABSTRACTIONS.</p>
</li>
</ol>
</blockquote>
<p>This is extremely important for designing and implementing testable software. Let's be clear here; we're talking about unit tests (or automated tests) where we want to be able to (at least) have fine-grained tests that test the smallest <em>unit</em> possible per test which allows us to find and fix problems much more quickly. With top-down designed software, there's no easy way to separate out these smaller units of code for testing.</p>
<p>Let's look an example. Say I have an MVC application that has a CategoryController. And with any typical MVC application the controller translates view actions into interactions with the model. In a top-down design, you might have a CategoryController constructor like this</p>
<pre><code>publicclassCategoryController
{
	privateCategoryModel model;
 
	public CategoryController()
	{
		model = newCategoryModel();
	}
 
	//...
}
</code></pre>
<p><img src="http://pr-blog.azurewebsites.net/wp-content/uploads/2015/03/tip_of_the_iceberg_thumb.jpg" class="img-fluid" alt="66795" title="66795" />Imagine if this top-down design continued, where CategoryModel depended on various things, and the various things that CategoryModel depended on depended on various other things… CategoryController would be the tip of an iceberg with untold depths of dependencies below the surface, all of which limiting our ability to use CategoryController in any but one scenario (especially not the testing scenario).</p>
<p>From a functionality standpoint <em>top-down design works</em>. But to test the tip of the iceberg we end up <em>testing the whole iceberg</em>. To test CategoryController we'd have to write a test like this.</p>
<pre><code>[Test]
publicvoid ListActionReturnsListOfCategories()
{
	var controller = newCategoryController();
 
	var result = (ViewResult) controller.List();
	Assert.IsTrue(result.ViewData.Model isIEnumerable&lt;Category&gt;);
	IEnumerable&lt;Category&gt; listCategories = (IEnumerable&lt;Category&gt;) result.ViewData.Model;
 
	Assert.AreEqual(1, listCategories.Count());
}
</code></pre>
<p>But, for this to work we have to make sure all the requirements are met for CategoryModel to operate correctly. If CategoryModel is an abstraction around a Repository implementation or a data context (like Entity Framework), then there is a lot of configuration required for our simple tests to run. Having test setup code to do this configuration is simply not feasible. It's unreasonable for test setup code to install and configure SQL Server, for example. Even if we <em>did</em> spend the time to get that configuration done (and that would be on <em>one</em> developer workstation) we'd end up testing the controller, the model, the database server, the database scheme, the test data, etc.—any of which could cause a test failure limiting our ability to focus on <em>where</em> the failure was (or whether it was a configuration error). No, we want to be able to execute tests with zero configuration dependencies.</p>
<p>In this top-down design implementation, the controller takes a dependency on CategoryModel (has ownership). We want to <em>invert</em> that dependency such that ownership is inverted and that the controller simply takes a dependence at the code level on an abstraction. But, since the controller is currently the owner of the model, we must first talk about The Dependency Injection Pattern.</p>
<p>The Dependency Injection pattern defines that the dependencies that one unit (class or method) requires be <em>injected</em> into the unit. This means that the dependency be instantiated outside the unit and be passed in (either in a constructor if it is a mandatory class dependency, a property if it is an optional class dependency, or as a parameter of the method if it is a method dependency). Optional class dependencies and method dependencies are really indications that there is a responsibility problem (i.e. something has taken on too much responsibility) so I generally try to focus solely on constructor injection.</p>
<p>In the case of our CategoryController, this means creating a model abstraction and injecting an instance of an implementation of that abstraction into our controller. Our model is fairly simple, so our abstraction might look like this:</p>
<pre><code>publicinterfaceICategoryModel
{
	IEnumerable&lt;Category&gt; List();
}
</code></pre>
<p>And we'd derive our CategoryModel class from ICategoryModel:</p>
<pre><code>publicclassCategoryModel : ICategoryModel
{
	publicIEnumerable&lt;Category&gt; List()
	{
		//...
	}
	//...
}
</code></pre>
<p>And in order to use this in production code, instead of simply instantiating the controller, we'd instantiate the model first:</p>
<pre><code>var controller = newCategoryController(newCategoryModel());
</code></pre>
<p>And, of course, modify CategoryController like this:</p>
<pre><code>publicclassCategoryController
{
	privateICategoryModel model;
 
	public CategoryController(ICategoryModel categoryModel)
	{
		model = categoryModel;
	}
 
	//...
}
</code></pre>
<p>Keep in mind that the composition of the controller would be done in a MVC-compatible factory.</p>
<p>But, now we are free to use any ICategoryModel implementation when composing a CategoryController. In the case were we want to focus on the unit of CategoryController.List(), we can mock away the production-level model and focus solely on the CategoryControl.List() unit. So, we might update our test method as follows:</p>
<pre><code>[Test]
publicvoid ListActionReturnsListOfCategories()
{
	var controller = newCategoryController(newMockCategoryModel());
 
	var result = (ActionResult) controller.List();
	Assert.IsTrue(result.ViewData.Model isIEnumerable&lt;Category&gt;);
	IEnumerable&lt;Category&gt; listCategories = (IEnumerable&lt;Category&gt;) result.ViewData.Model;
 
	Assert.AreEqual(1, listCategories.Count());
}
</code></pre>
<p><img src="http://pr-blog.azurewebsites.net/wp-content/uploads/2015/03/IceCubes_thumb.png" class="img-fluid" alt="Ice-Cubes" title="Ice-Cubes" /> Now we are able to reason about smaller parts of our system. This allows us (or forces us, depending on your point of view) to compose our systems from smaller, decoupled, parts (like ice cubes instead of one iceberg). We instantiate several objects independently (each of which is injected into another) to compose a system. We can compose those instances in the way we'd need for our production system, or we could compose those instances in a way that allows is to test individual units of code. This allows us to get away from the <em>tip of the iceberg</em> design smell that plagued our ability to test.</p>
<p>By taking on this bottom-up design design philosophy it allows us the freedom to compose our systems and subsystems in code (in other words at run-time) offering great flexibility in the granularity at which we can test. We can still perform integration and system-level automated testing, but now we're free to have fine grain tests that will run quickly and fail fast allowing very quick and tight dev/test cycles.</p>
<p>If you're new to this bottom-up design philosophy and want to get better at composable systems, I'd recommend trying to do Test-Driven Design (TDD) whenever you can. TDD forces you to create simple tests before you start to write the system under test, so it forces you to have a testable (and thus likely composable) design.</p>
<p>When we allow accidental complexity into our software, design, and processes; what we are really doing is adding needless coupling. The more complex something is, the more it is coupled to many, potentially unrelated, things. With that increased coupling it's hard to make fine-grained changes to things. To make the changes we want to make takes much more work and causes much more instability. But that's for yet another blog post.</p>


<div id="disqus_thread"></div>  
<!--
    'Writing-Unit-Tests-is-Hard%2C-Because%E2%80%A6'
    'Writing Unit Tests is Hard, Because&#x2026;'
    'http://blog.peterritchie.com/posts/Writing-Unit-Tests-is-Hard%2C-Because%E2%80%A6'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('3/10/15');
    console.info('Writing-Unit-Tests-is-Hard%2C-Because%E2%80%A6');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Writing Unit Tests is Hard, Because&#x2026;';
    var disqus_url = 'http://blog.peterritchie.com/posts/Writing-Unit-Tests-is-Hard%2C-Because%E2%80%A6';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Writing-Unit-Tests-is-Hard%2C-Because%E2%80%A6';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2025
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>&nbsp;|<a rel="me" href="https://bsky.app/profile/peterritchie.com">Bluesky</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

