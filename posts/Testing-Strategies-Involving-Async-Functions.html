
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - Testing Strategies Involving Async Functions</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - Testing Strategies Involving Async Functions" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/Testing-Strategies-Involving-Async-Functions" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Testing Strategies Involving Async Functions</h1>
    <div class="meta">        
Published on Thursday, November 4, 2010<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/NET-Development" class="btn btn-default btn-xs">.NET Development</a>
                    <a role="button" href="/tags/Async-Functions" class="btn btn-default btn-xs">Async Functions</a>
                    <a role="button" href="/tags/C%23-5" class="btn btn-default btn-xs">C# 5</a>
                    <a role="button" href="/tags/Design/Coding-Guidance" class="btn btn-default btn-xs">Design/Coding Guidance</a>
                    <a role="button" href="/tags/DevCenterPost" class="btn btn-default btn-xs">DevCenterPost</a>
                    <a role="button" href="/tags/November-2010" class="btn btn-default btn-xs">November 2010</a>
                    <a role="button" href="/tags/Software-Development" class="btn btn-default btn-xs">Software Development</a>
                    <a role="button" href="/tags/TDD" class="btn btn-default btn-xs">TDD</a>
                    <a role="button" href="/tags/Unit-Testing" class="btn btn-default btn-xs">Unit Testing</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://blogs.msmvps.com/peterritchie/2010/11/04/testing-strategies-involving-async-functions/" title="Permalink to Testing Strategies Involving Async Functions">Source</a></p>
<h1 id="testing-strategies-involving-async-functions">Testing Strategies Involving Async Functions</h1>
<p>Some things to keep in mind when writing units tests for code that use<br />
async methods: You're not trying to test the framework's &quot;awaitability&quot;<br />
and you're not trying to test framework methods that are &quot;awaitable&quot;.<br />
You want to test your code in certain isolation contexts. One context,<br />
of course, is independent of asynchronicity–do individual units of code<br />
that don't depend on asynchronous invocation &quot;work&quot;… e.g.<br />
&quot;Task<string> MyMethodAsync()&quot;, you want to have a unit test that<br />
make sure this method does what it's supposed to do (one being it<br />
returns a &quot;valid&quot; <code>Task&lt;string&gt;</code> object, the other being that<br />
individual side-effects occur, if any). Another context is dependent on<br />
asynchronicity–do individual units of code that do depend on<br />
asynchronous invocation (or depend on something being invoked<br />
asynchronously) &quot;work&quot;.</p>
<p>It's the second context that seems to be the hardest to grasp for most<br />
people to grasp and action.<br />
Let's take this example code:</p>
<pre><code>	privateasyncvoidstartButton_Click(objectsender,EventArgse)  
{  
try  
{  
startButton.Enabled=false;  
varwebRequest=WebRequest.Create(&quot;http://google.ca&quot;);  
using(varresponse=awaitwebRequest.GetResponseAsync())  
using(varstream=response.GetResponseStream())  
{  
if(stream==null)return;  
using(varreader=newStreamReader(stream))  
{  
textBox.Text=awaitreader.ReadToEndAsync();  
}  
}  
}  
finally  
{  
startButton.Enabled=true;  
}  
}  
</code></pre>
<p>A couple invariants that we want to test might be that the button is disabled during the asynchronous operations and enabled after the asynchronous operations. It's not immediately obvious what to in order to validate these invariants.</p>
<p>When the compiler encounters the await operator, it actually goes searching for method that can act upon the type of the object being returned by the method used with the await operator. In our first use of await (on GetResponseAsync()) the return type is <code>Task&lt;T&gt;</code> (Task<WebResponse> specifically, but for our example I'll use <code>Task&lt;T&gt;</code>). There's various criteria the computer uses to search for this method, one method is to search for extension methods that match the name and return an &quot;awaiter&quot; type that has the following methods: BeginAwait and EndAwait (more details can be found in the Aync CTP documentation). The compiler doesn't allow us to inject an awaiter type in the normal run-time dependency injection semantics; but it does allow us to implement an awaiter that does support dependency injection at run-time. To do this I would create an ITaskAwaiter interface like this:</p>
<pre><code>	publicinterfaceITaskAwaiter&lt;outT&gt;  
{  
boolBeginAwait(Actioncontinuation);  
TEndAwait();  
}  
</code></pre>
<p>I then need to create a GetAwaiter(this <code>Task&lt;T&gt;</code>) extension method to return an implementation of this type. The built-in System.Runtime.CompilerServices.TaskAwaiter<T> is public; but, unfortunately it's constructor (and the ability to pass in a <code>Task&lt;T&gt;</code>) object is internal. So, we can't simply wrap the built-in awaiter and delegate to it as a default. We actually have to write an awaiter that mimics what the built-in one does. For example:</p>
<pre><code>	publicclassTaskAwaiter&lt;T&gt;:ITaskAwaiter&lt;T&gt;  
{  
privatereadonlyTask&lt;T&gt;task;

publicTaskAwaiter(Task&lt;T&gt;task)  
{  
this.task=task;  
}

publicboolBeginAwait(Actioncontinuation)  
{  
if(task.IsCompleted)returnfalse;  
varsynchronizationContext=SynchronizationContext.Current;  
`Action&lt;Task&gt;`action=theTask=&gt;  
	{  
		if(synchronizationContext!=null)  
		{  
			synchronizationContext.Post(state=&gt;continuation(),null);  
		}  
		else  
		{  
			continuation();  
		}  
	};

task.ContinueWith(action,CancellationToken.None,TaskContinuationOptions.ExecuteSynchronously,TaskScheduler.Current);  
returntrue;  
}

publicTEndAwait()  
{  
returntask.Result;  
}  
}
</code></pre>
<p>This class is given the <code>Task&lt;T&gt;</code> in question, it implements a BeginWait method that sets up an Action delegate to invoke the continuation given to it in a specific synchronization context, then tells the task to use that new action as it's continuation via a call to ContinueWith. When the task is completed EndAwait will be called and we simply return the result of the task.</p>
<p>Now, in order to add the ability to inject a customer awaiter, we need to provide the GetAwaiter extension method. For example:</p>
<pre><code>	namespacePRI.Extensions  
{  
staticclassTaskExtensions  
{  
staticpublicITaskAwaiter&lt;TResult&gt;GetAwaiter&lt;TResult&gt;(thisTask&lt;TResult&gt;task)  
{  
returnTaskAwaiterFactory&lt;TResult&gt;.CreateTaskAwaiter!=null  
?TaskAwaiterFactory&lt;TResult&gt;.CreateTaskAwaiter(task):newTaskAwaiter&lt;TResult&gt;(task);  
}  
}  
}
</code></pre>
<p>This extension method invokes a factory method delegate to create the ITaskAwaiter<T> object (or simply creates our new default awaiter). This factory method looks like this:</p>
<pre><code>	internalstaticclassTaskAwaiterFactory&lt;TResult&gt;  
{  
privatestaticFunc&lt;Task&lt;TResult&gt;,ITaskAwaiter&lt;TResult&gt;&gt;createTaskAwaiter=task=&gt;  
	{  
		Current=newTaskAwaiter&lt;TResult&gt;(task);  
		returnCurrent;  
	};  
publicstaticFunc&lt;Task&lt;TResult&gt;,ITaskAwaiter&lt;TResult&gt;&gt;CreateTaskAwaiter  
{  
get{returncreateTaskAwaiter;}  
set  
{  
createTaskAwaiter=task=&gt;  
	{  
		Current=value(task);  
		returnCurrent;  
	};  
}  
}  
publicstaticITaskAwaiter&lt;TResult&gt;Current{get;privateset;}  
}
</code></pre>
<p>We can override this factory method and give a delegate to code that creates another type of ITaskAwaiter<T> implementation. We also decorate the call to that provided delegate with something that keeps track of the Current awaiter (more on that later). Now, we simply need to add a using statement within our namespace for the compiler to user our GetAwaiter when it compiles an await operator and use our factory. For example:</p>
<pre><code>	namespacePRI.MainApplication  
{  
usingPRI.Extensions;

//...  
</code></pre>
<p>We're now all set to inject a new awaiter and be able to isolate our code from the framework and validate some invariants. In our case, we'd like to check to make sure that the button is disabled during invocation of asynchronous operations and enabled when done. So, we can create a spy awaiter that basically does nothing and sends back a fake or dummy object. In our example we actually have two different types of <code>Task&lt;T&gt;</code> objects being awaited; so, we need to create a couple of awaiter spys. One is generic and one is specific. For example:</p>
<pre><code>	publicclassWebResponseTaskAwaiterSpy:ITaskAwaiter&lt;WebResponse&gt;  
{  
privateclassFakeWebResponse:WebResponse  
{  
publicoverrideStreamGetResponseStream()  
{  
returnnewMemoryStream(System.Text.Encoding.ASCII.GetBytes(&quot;gotsometext&quot;));  
}  
}  
privatereadonlyMainFormform;  
publicboolButtonEnabledState{get;privateset;}  
publicWebResponseTaskAwaiterSpy(MainFormform)  
{  
this.form=form;  
}

publicboolBeginAwait(Actioncontinuation)  
{  
returnfalse;  
}

publicWebResponseEndAwait()  
{  
ButtonEnabledState=form.startButton.Enabled;  
returnnewFakeWebResponse();  
}  
}

publicclassTaskAwaiterSpy&lt;T&gt;:ITaskAwaiter&lt;T&gt;  
{  
privatereadonlyMainFormform;  
publicboolButtonEnabledState{get;privateset;}  
publicTaskAwaiterSpy(MainFormform)  
{  
this.form=form;  
}

publicboolBeginAwait(Actioncontinuation)  
{  
returnfalse;  
}

publicTEndAwait()  
{  
ButtonEnabledState=form.startButton.Enabled;  
returndefault(T);  
}  
}
</code></pre>
<p>Both classes don't actually execute the task because we know task execution works and we know it works asynchronously–we're not trying to test that. The clases return false from BeginAwait to tell the generated code that the asynchronous code &quot;completed&quot; (we lie). The generated code the calls the EndAwait method to get the result of the so-called asynchronous operation. In both cases, we get the state of the button in EndAwait. In the case of the generic spy, we simply return a dummy–the default value for that type parameter. In the case of the WebResponse spy, we can't send back a dummy because that would be a null value and we'd get NullReferenceEexceptions that would abort our test. So, we create a FakeWebResponse object and send that back that basically creates a canned response stream in memory and sends it back and that will be used in our second await.</p>
<p>Now, we can write a unit test for startButton_Click method. For example:</p>
<pre><code>	MainFormform=CreateForm();  
`TaskAwaiterFactory&lt;WebResponse&gt;`.CreateTaskAwaiter=task=&gt;newWebResponseTaskAwaiterSpy(form);  
`TaskAwaiterFactory&lt;String&gt;`.CreateTaskAwaiter=task=&gt;newTaskAwaiterSpy&lt;String&gt;(form);

form.startButton_Click(null,EventArgs.Empty);

varspy1=TaskAwaiterFactory&lt;WebResponse&gt;.CurrentasWebResponseTaskAwaiterSpy;  
varspy2=TaskAwaiterFactory&lt;String&gt;.CurrentasTaskAwaiterSpy&lt;String&gt;;

Assert.IsTrue((spy2!=null&amp;&amp;!spy2.ButtonEnabledState)&amp;&amp;(spy1!=null&amp;&amp;!spy1.ButtonEnabledState));  
Assert.IsTrue(form.startButton.Enabled);  
</code></pre>
<p>This code injects our two types of awaiters (our spies), invokes the method, then checks the spies for the values we're looking for as well as the current state of our button (we assume the current state at this point is the same state immediately after the asynchronous operation completed) to validate our invariants.</p>
<p><img src="http://dotnetkicks.com/Services/Images/KickItImageGenerator.ashx?url=http%253a%252f%252fmsmvps.com%252fblogs%252fpeterritchie%252farchive%252f2010%252f11%252f04%252ftesting-strategies-involving-async-functions.aspx" class="img-fluid" alt="kick it on DotNetKicks.com" /></p>


<div id="disqus_thread"></div>  
<!--
    'Testing-Strategies-Involving-Async-Functions'
    'Testing Strategies Involving Async Functions'
    'http://blog.peterritchie.com/posts/Testing-Strategies-Involving-Async-Functions'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('11/4/10');
    console.info('Testing-Strategies-Involving-Async-Functions');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Testing Strategies Involving Async Functions';
    var disqus_url = 'http://blog.peterritchie.com/posts/Testing-Strategies-Involving-Async-Functions';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Testing-Strategies-Involving-Async-Functions';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2024
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://dotnet.social/@peterritchie">dotnet.social</a>&nbsp;|&nbsp;<a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

