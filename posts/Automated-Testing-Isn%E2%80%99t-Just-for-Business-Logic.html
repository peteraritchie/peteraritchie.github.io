
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - Automated Testing Isn&#x2019;t Just for Business Logic</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - Automated Testing Isn&#x2019;t Just for Business Logic" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/Automated-Testing-Isn%E2%80%99t-Just-for-Business-Logic" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Automated Testing Isn&#x2019;t Just for Business Logic</h1>
    <div class="meta">        
Published on Friday, May 25, 2012<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/NET-Development" class="btn btn-default btn-xs">.NET Development</a>
                    <a role="button" href="/tags/C%23" class="btn btn-default btn-xs">C#</a>
                    <a role="button" href="/tags/DevCenterPost" class="btn btn-default btn-xs">DevCenterPost</a>
                    <a role="button" href="/tags/May-2012" class="btn btn-default btn-xs">May 2012</a>
                    <a role="button" href="/tags/Software-Development" class="btn btn-default btn-xs">Software Development</a>
                    <a role="button" href="/tags/Software-Development-Guidance" class="btn btn-default btn-xs">Software Development Guidance</a>
                    <a role="button" href="/tags/TDD" class="btn btn-default btn-xs">TDD</a>
                    <a role="button" href="/tags/Unit-Testing" class="btn btn-default btn-xs">Unit Testing</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://blogs.msmvps.com/peterritchie/2012/05/25/automated-testing-isn-t-just-for-business-logic/" title="Permalink to Automated Testing Isn’t Just for Business Logic">Source</a></p>
<h1 id="automated-testing-isnt-just-for-business-logic">Automated Testing Isn’t Just for Business Logic</h1>
<p>I had a conversation with <a href="http://bit.ly/LAcF5n">Kelly Sommers</a> the other day that was partially a short <em>support group session</em> on the annoying tendencies of development teams to completely lose focus on the architecture and design principles of a system and let the code base devolve into a ball of muddy spaghetti.</p>
<p>One particular area that we discussed, and it's one area I've detailed <a href="http://bit.ly/c13trs">elsewhere</a>, has to do with layers. Our gripe was that developers seem to completely ignore layering principles once they start coding and introduce cycles, put things in the wrong layer, etc. <strong>A brief recap of layering principles</strong>: Types in one layer can only access types in the adjacent lower layer. That's it. Types that access types in a layer above are violating layering (or aren't layer) and types that access types in a layer lower than the adjacent lower level (e.g. two layers down) are violating layering.</p>
<p>I've blogged about Visual Studio and layers (and <a href="http://bit.ly/MAXJUp">validation</a>) before; but not everyone uses the part of Visual Studio or doesn't have that edition of Visual Studio. I mentioned in our conversation it's fairly easy to write unit tests to make these verifications. I've written tests like this before, but the assumption was that &quot;layers&quot; were in different assemblies. The verification for this scenario is quite a bit simpler; so, I thought I'd tackle a test that verifies layering within a single assembly where namespaces are the scope of layers.</p>
<p>My initial code used Enumerable.Any to see if any types from a lower layer not adjacent to the current layer where used in this layer or whether any types from any layers above the current layer where used in this layer. This did the validation, but basically left the dev with a &quot;test failed and I'm not giving you any details&quot; message because we couldn't tell where the violation was and what violated it—which isn't too friendly. So, I expanded it out to detail **all **the violations. I came up with a utility method ValidateLayerRelationships would be used as follows:</p>
<pre><code>publicenumLayer{
//Orderisimportant!
Data,
Domain,
UI
}
 
[TestMethod]
publicvoidValidateLayerUsage()
{
varrelatedNamespaces=new[]{&quot;PRI.Data&quot;,&quot;PRI.Domain&quot;,&quot;PRI.FrontEnd&quot;,&quot;PRI.ViewModels&quot;};
 
varlevelMap=newDictionary&lt;string,Layer&gt;{
{relatedNamespaces[0],Layer.Data},
{relatedNamespaces[1],Layer.Domain},
{relatedNamespaces[2],Layer.UI},
{relatedNamespaces[3],Layer.UI},
};
 
varassemblyFileName=&quot;ClassLibrary.dll&quot;;
ValidateLayerRelationships(levelMap,assemblyFileName);
}
</code></pre>
<p>In this example I have two namespaces in one layer (the UI layer) FrontEnd and ViewModels and two other layers with just one namespace in each (Data with Data and Domain with Domain). mostly to show you can have more than one namespace per layer… We define a layer map, and the filename of the assembly we want to validate and call ValidateLayerRelationships. ValidateLayerRelationships is as follows:</p>
<pre><code>privatestaticvoidValidateLayerRelationships(Dictionary&lt;string,Layer&gt;levelMap,stringassemblyFileName){
//can'tuseReflectionOnlyLoadFrombecausewewanttopeekatattributes
vargroups=fromtinAssembly.LoadFrom(assemblyFileName).GetTypes()
wherelevelMap.Keys.Contains(t.Namespace)
grouptbyt.Namespace
intog
orderbylevelMap[g.Key]
selectg;
 
varlevelsWithClasses=groups.Count();
Assert.IsTrue(levelsWithClasses&gt;1,&quot;Needmorethantwolayerstovalidaterelationships.&quot;);
 
varerrors=newList&lt;string&gt;();
foreach(vargingroups){
varlayer=levelMap[g.Key];
//verifythislevelonlyaccessesthingsfromtheadjacentlowerlayer(orlayers)
varoffLimitSubsets=fromg1ingroupswhere!new[]{layer-1,layer}.Contains(levelMap[g1.Key])selectg1;
varoffLimitTypes=offLimitSubsets.SelectMany(x=&gt;x).ToList();
foreach(Typeting){
foreach(MethodInfomint.GetAllMethods()){
varmethodBody=m.GetMethodBody();
if(methodBody!=null)
foreach(LocalVariableInfovinmethodBody
.LocalVariables
.Where(v=&gt;offLimitTypes
.Contains(v.LocalType)))
{
errors.Add(
string.Format(
&quot;Method&quot;{0}&quot;haslocalvariableoftype{1}fromalayeritshouldn't.&quot;,
m.Name,
v.LocalType.FullName));
}
foreach(ParameterInfopinm
.GetParameters()
.Where(p=&gt;offLimitTypes
.Contains(p.ParameterType)))
{
errors.Add(
string.Format(
&quot;Method&quot;{0}&quot;parameter{2}usesparametertype{1}fromalayeritshouldn't.&quot;,
m.Name,
p.ParameterType.FullName,
p.Name));
}
if(offLimitTypes.Contains(m.ReturnType)){
errors.Add(
string.Format(
&quot;Method&quot;{0}&quot;usesreturntype{1}fromalayeritshouldn't.&quot;,
m.Name,
m.ReturnType.FullName));
}
}
foreach(PropertyInfopint
.GetAllProperties()
.Where(p=&gt;offLimitTypes.Contains(p.PropertyType)))
{
errors.Add(
string.Format(
&quot;Type&quot;{0}&quot;hasaproperty&quot;{1}&quot;oftype{2}fromalayeritshouldn't.&quot;,
t.FullName,
p.Name,
p.PropertyType.FullName));
}
foreach(FieldInfofint.GetAllFields().Where(f=&gt;offLimitTypes.Contains(f.FieldType)))
{
errors.Add(
string.Format(
&quot;Type&quot;{0}&quot;hasafield&quot;{1}&quot;oftype{2}fromalayeritshouldn't.&quot;,
t.FullName,
f.Name,
f.FieldType.FullName));
}
}
}
if(errors.Count&gt;0)
Assert.Fail(String.Join(Environment.NewLine,new[]{&quot;Layeringviolation.&quot;}.Concat(errors)));
}
</code></pre>
<p>This method groups types within a layer, then goes through any layers that layer shouldn't have access to (i.e. any layer that isn't the lower adjacent layer, or &quot;layer – 1, layer&quot; where we create offLimitSubsets). For each type we look at return values, parameter values, fields, properties, and methods for any types they use. If any of those types are one of the off limit types, we add an error to our error collection. At the end, if there's any errors we assert and format a nice message with all the violations.</p>
<p>This is a helper method that you'd use somewhere (maybe a helper static class, within the existing test class, whatever).</p>
<p>This uses some extension classes to make it a bit more readable, which are here:</p>
<pre><code>publicstaticclassTypeExceptions{
publicstaticIEnumerable&lt;MethodInfo&gt;GetAllMethods(thisTypetype){
if(type==null)thrownewArgumentNullException(&quot;type&quot;);
return
type.GetMethods(BindingFlags.Instance|BindingFlags.NonPublic|BindingFlags.Static|BindingFlags.Public).Where(
m=&gt;!m.GetCustomAttributes(true).Any(a=&gt;aisCompilerGeneratedAttribute));
}
publicstaticIEnumerable&lt;FieldInfo&gt;GetAllFields(thisTypetype){
if(type==null)thrownewArgumentNullException(&quot;type&quot;);
returntype.GetFields(BindingFlags.Instance|BindingFlags.NonPublic|BindingFlags.Static|BindingFlags.Public)
.Where(f=&gt;!f.GetCustomAttributes(true).Any(a=&gt;aisCompilerGeneratedAttribute));
}
publicstaticIEnumerable&lt;PropertyInfo&gt;GetAllProperties(thisTypetype){
if(type==null)thrownewArgumentNullException(&quot;type&quot;);
return
type.GetProperties(BindingFlags.Instance|BindingFlags.NonPublic|BindingFlags.Static|BindingFlags.Public).Where
(p=&gt;!p.GetCustomAttributes(true).Any(a=&gt;aisCompilerGeneratedAttribute));
}
}
</code></pre>
<p>Because the compiler generates fields for auto properties and methods for properties, we want to filter out any compiler-generated stuff (what caused the compiler to generate the code will raise a violation) so we don't get any duplicate violations (and violations the user can't do anything about). (which is what the call to GetCustomAttributes is doing)</p>
<p>I wasn't expecting this to be that long; so, in future blog entries I'll try to detail some other unit tests that validate or verify specific infrastructural details. If you have any specific details you're interested in, leave a comment.</p>


<div id="disqus_thread"></div>  
<!--
    'Automated-Testing-Isn%E2%80%99t-Just-for-Business-Logic'
    'Automated Testing Isn&#x2019;t Just for Business Logic'
    'http://blog.peterritchie.com/posts/Automated-Testing-Isn%E2%80%99t-Just-for-Business-Logic'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('5/25/12');
    console.info('Automated-Testing-Isn%E2%80%99t-Just-for-Business-Logic');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Automated Testing Isn&#x2019;t Just for Business Logic';
    var disqus_url = 'http://blog.peterritchie.com/posts/Automated-Testing-Isn%E2%80%99t-Just-for-Business-Logic';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Automated-Testing-Isn%E2%80%99t-Just-for-Business-Logic';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

