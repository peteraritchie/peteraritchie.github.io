
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - Multi-targeting in Visual Studio 2017</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - Multi-targeting in Visual Studio 2017" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/Multi-targeting-in-Visual-Studio-2017" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Multi-targeting in Visual Studio 2017</h1>
    <div class="meta">        
Published on Friday, June 16, 2017<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/June-2017" class="btn btn-default btn-xs">June 2017</a>
                    <a role="button" href="/tags/Visual-Studio-2017" class="btn btn-default btn-xs">Visual Studio 2017</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p>I've got a few OSS projects on the go that have evolved over time enough that some target more than one version of .NET.  Recently I started adding support to some of those projects for .NET Standard and .NET Core. Traditionally I've attempted to support multiple targets with multiple projects: since there's a single target framework in a project.  This has served me well over the years.  Here's some details:</p>
<p>Once you've got a project on the go and a Nuget package being used, Microsoft releases a new framework.  Eventually there may be something you need to support but can't just drop your assembly that only supports the previous version, so you you create new project targeting the new framework.  Usually a new framework is backwards compatible with the version you're already deploying for, so all the code you currently have should work fine with the new framework.  The best way I've found so far is to simply link to all the existing files in the new project.  In Solution Explorer, right-click the new project and click <strong>Add►Existing File…</strong> and select the files you want to add as a link and click the ► in the <strong>Add ►</strong> button and click <strong>Add Link</strong>. This adds links to the files from another projetc so each file is shared across the two projects.  If you edit one, you edit for both (or all projects).  If you have a lot of files across more than few directories, you'll quickly notice that using the <strong>Add►Existing File…</strong> dialog will be a huge chore.  An easier way is to select the files in the previous project in Solution Explorer and drag and drop the files you want to share while holding the <strong>Alt</strong> key to the new project.  This will add links to your new project.  At this point, the project should compile and effectively give you an identical class library that supports the new framework.  For any new framework features you want to support, simply add them as new files into the project for that framework (remember <code>partial</code> if you want to add new framework functionality to an existing class.  In rare cases you may need to add a some compile-time constants like <code>NET40</code> and <code>NET45</code> to each project so that you can wire-off specific functionality in a shared file.</p>
<p>Now when you want to generate your new Nuget package, you can copy the library dlls into a convention-based folder that Nuget understands.  For example:</p>
<pre><code>\lib
    \net40
        myassembly.dll
    \netstandard1.3
        musassembly.dll
</code></pre>
<p>For example, one of my OSS projects, files are copied into a Nuget-convention <code>lib</code> folder like this:</p>
<pre><code>copy Pri.LongPath.net40\bin\Release\Pri.LongPath.dll nuget\lib\net40
copy Pri.LongPath.net200\bin\Release\Pri.LongPath.dll nuget\lib\net20
</code></pre>
<p>Then Nuget just packages things properly.</p>
<p>This works, but realistically it's quite a bit of work.  Over time you get more and more projects, and if you have lots of files, you have more and more files in Solution Explorer and performance seems to suffer.</p>
<p>Fortunately, I've found that there's a much better way in Visual Studio 2017 and the new csproj files: via the <a href="https://docs.microsoft.com/en-us/dotnet/core/tutorials/libraries">TargetFrameworks</a> element.  There does not seem to be support for this in the Visual Studio UI yet, so you have to manually edit your csproj to add support for multiple frameworks; but that's easy with the new csproj files because you can simply edit them in Visual Studio 2017 (right-click project in Solution Explorer and select <strong>Edit</strong>).  Once there, simply rename the <code>TargetFramework</code> element to <code>TargetFrameworks</code> (note the 's' suffix).  For example, if you create a .NET Standard class library, the csproj will contain the following:</p>
<pre><code>&lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt;

&lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;netstandard1.3&lt;/TargetFramework&gt;
&lt;!-- ... --&gt;
</code></pre>
<p>to support .NET Standard 1.3 <em>and</em> .NET 4.6.2, change that to the following:</p>
<pre><code>&lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt;

&lt;PropertyGroup&gt;
    &lt;TargetFrameworks&gt;netstandard1.3;net462&lt;/TargetFrameworks&gt;
&lt;!-- ... --&gt;
</code></pre>
<p>Note the use of semicolons to separate framework monikers.</p>
<p>This method means that the one project is built for each framework and all the files are shared amongst those builds.  This means you have to resort to compile-time constants to signify framework-specific code.  Fortunately Visual Studio (or really the build system) knows about our multi-targeting, so it automatically provides compile-time constants.  The following table shows current compile-time constants (and the convention it uses, for future framework versions :) ):</p>
<pre><code>.NET Framework 2.0   --&gt; NET20
.NET Framework 3.5   --&gt; NET35
.NET Framework 4.0   --&gt; NET40
.NET Framework 4.5   --&gt; NET45
.NET Framework 4.5.1 --&gt; NET451
.NET Framework 4.5.2 --&gt; NET452
.NET Framework 4.6   --&gt; NET46
.NET Framework 4.6.1 --&gt; NET461
.NET Framework 4.6.2 --&gt; NET462
.NET Standard 1.0    --&gt; NETSTANDARD1_0
.NET Standard 1.1    --&gt; NETSTANDARD1_1
.NET Standard 1.2    --&gt; NETSTANDARD1_2
.NET Standard 1.3    --&gt; NETSTANDARD1_3
.NET Standard 1.4    --&gt; NETSTANDARD1_4
.NET Standard 1.5    --&gt; NETSTANDARD1_5
.NET Standard 1.6    --&gt; NETSTANDARD1_6 
</code></pre>
<p>For example:</p>
<pre><code>#if (NET45 || NET451 || NET452 || NET46 || NET461 || NET462)

	public static Task ConnectAsync(this TcpClient tcpClient, EndPoint endPoint)
	{
		//...
	}
#endif
</code></pre>
<p>To edit code in the context of a particular framework (and thus have the particular compile-time constants defined) you can select the file projects dropdown to show the file in the compiler context of the target:</p>
<p><img src="/assets/file%20projects%20dropdown.png" class="img-fluid" alt="file projects dropdown" /></p>
<p>Now when you build the project it will create a binary for each target platform (within the bin directory under Debug/Release and subdirectories by target name like &quot;net45&quot;).</p>
<p>With a .NET Standard project in Visual Studio you can also have it create the Nuget package during build.  Since the project builds the nuget, you enter all the package information in the project settings.  And, of course, this means it builds a package with all the target binaries, not just one so you don't need to create a nuspec, nor edit it, more create a convention-based directory structure with the binaries for all the target frameworks you support.</p>
<h3 id="caveats">Caveats</h3>
<p>As mentioned earlier, VS doesn't support multi-targeting like this right in the UI (other than the file projects dropdown to view the file in the compiler context of the target) so it can be tedious editing the csproj manually to change configuration like references etc.</p>


<div id="disqus_thread"></div>  
<!--
    'Multi-targeting-in-Visual-Studio-2017'
    'Multi-targeting in Visual Studio 2017'
    'http://blog.peterritchie.com/posts/Multi-targeting-in-Visual-Studio-2017'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('6/16/17');
    console.info('Multi-targeting-in-Visual-Studio-2017');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Multi-targeting in Visual Studio 2017';
    var disqus_url = 'http://blog.peterritchie.com/posts/Multi-targeting-in-Visual-Studio-2017';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Multi-targeting-in-Visual-Studio-2017';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2025
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://dotnet.social/@peterritchie">dotnet.social</a>&nbsp;|&nbsp;<a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

