
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - ITSWITCH #1: Answer</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - ITSWITCH #1: Answer" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/ITSWITCH-%231%3A-Answer" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>ITSWITCH #1: Answer</h1>
    <div class="meta">        
Published on Monday, July 28, 2008<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/NET-20" class="btn btn-default btn-xs">.NET 2.0</a>
                    <a role="button" href="/tags/NET-Development" class="btn btn-default btn-xs">.NET Development</a>
                    <a role="button" href="/tags/C%23" class="btn btn-default btn-xs">C#</a>
                    <a role="button" href="/tags/Design/Coding-Guidance" class="btn btn-default btn-xs">Design/Coding Guidance</a>
                    <a role="button" href="/tags/ITSWITCH-Answer" class="btn btn-default btn-xs">ITSWITCH Answer</a>
                    <a role="button" href="/tags/July-2008" class="btn btn-default btn-xs">July 2008</a>
                    <a role="button" href="/tags/Pop-Quiz" class="btn btn-default btn-xs">Pop Quiz</a>
                    <a role="button" href="/tags/Software-Development" class="btn btn-default btn-xs">Software Development</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://blogs.msmvps.com/peterritchie/2008/07/28/itswitch-1-answer/" title="Permalink to ITSWITCH #1: Answer">Source</a></p>
<h1 id="itswitch-1-answer">ITSWITCH #1: Answer</h1>
<p><a href="http://blogs.msmvps.com/blogs/peterritchie/archive/2008/07/25/itswitch-1.aspx">Last post</a> I detailed some code that may or may not have something wrong in it. If you thought InitializeOne and IntializeTwo are semantically identical (e.g. they differ only by performance), you'd be wrong.</p>
<p>If you simply ran the code, you'd be able to guess where the problem is. To understand what's causing the problem. Let's look at how C# effectively implements the two loops.</p>
<p>InitializeOne is essentially equivalent to</p>
<pre><code> private class PrivateDelegateHelper


 {


 public String Value { get; set; }


 public void Method()


 {


 TestClass.ProcessText(Value);


 }


 }





 public void InitializeThree(String[] strings)


 {


 delegates = new List&lt;MethodInvoker&gt;(strings.Length);


 MethodInvoker cachedAnonymousDelegate = null;


 PrivateDelegateHelper privateDelegateHelper = new PrivateDelegateHelper();


 String[] copyOfStrings = strings;


 for(int i = 0; i &lt; copyOfStrings.Length; ++i)


 {


 privateDelegateHelper.Value = copyOfStrings[i];


 if (cachedAnonymousDelegate == null)


 {


 cachedAnonymousDelegate = new MethodInvoker(privateDelegateHelper.Method);


 }


 delegates.Add(cachedAnonymousDelegate);


 }


 }
</code></pre>
<p>Now it's obvious, right?</p>
<p>For those you don't want to read all the code, the problem is that only one PrivateDelegateHelper object is instantiated and its value property is set in each iteration of the loop. Because the delegates aren't run until sometime after the loop, they're all run with the last value of the string array as their argument.</p>
<p>The technical term for what we've implemented here is a <a href="http://en.wikipedia.org/wiki/Closure_(computer_science)">closure</a>. If you're using Resharper 4.x, you would have noticed a warning &quot;Access to modified closure&quot;:</p>
<p><img src="http://blogs.msmvps.com/cfs-filesystemfile.ashx/__key/CommunityServer.Blogs.Components.WeblogFiles/peterritchie/modified-closure.JPG" class="img-fluid" alt="" /></p>
<p>…which is attempting to tell you that the closure (the delegate and cached bound variables) has changed (in this case one of the bound variables has changed between the creation of a closure and another and out expected output is effected).</p>
<p>By the way, you can get the same thing with C# 3+ with lambdas (i.e. you can also write closures with lambdas):</p>
<pre><code> public void InitializeOne(String[] strings)


 {


 delegates = new List&lt;MethodInvoker&gt;(strings.Length);


 for (int i = 0; i &lt; strings.Length; ++i)


 {


 String value = strings[i];


 delegates.Add(() =&gt; ProcessText(value));


 }


 }





 public void InitializeTwo(String[] strings)


 {


 delegates = new List&lt;MethodInvoker&gt;(strings.Length);


 foreach(String value in strings)


 {


 delegates.Add(() =&gt; ProcessText(value));


 }


 }
</code></pre>


<div id="disqus_thread"></div>  
<!--
    'ITSWITCH-%231%3A-Answer'
    'ITSWITCH #1: Answer'
    'http://blog.peterritchie.com/posts/ITSWITCH-%231%3A-Answer'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('7/28/08');
    console.info('ITSWITCH-%231%3A-Answer');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'ITSWITCH #1: Answer';
    var disqus_url = 'http://blog.peterritchie.com/posts/ITSWITCH-%231%3A-Answer';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'ITSWITCH-%231%3A-Answer';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2022
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

