
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - DataContractSerializer.ReadObject is easily confused.</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - DataContractSerializer.ReadObject is easily confused." />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/DataContractSerializer.ReadObject-is-easily-confused." />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>DataContractSerializer.ReadObject is easily confused.</h1>
    <div class="meta">        
Published on Wednesday, April 29, 2009<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/NET-35" class="btn btn-default btn-xs">.NET 3.5</a>
                    <a role="button" href="/tags/April-2009" class="btn btn-default btn-xs">April 2009</a>
                    <a role="button" href="/tags/C%23" class="btn btn-default btn-xs">C#</a>
                    <a role="button" href="/tags/WCF" class="btn btn-default btn-xs">WCF</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://blogs.msmvps.com/peterritchie/2009/04/29/datacontractserializer-readobject-is-easily-confused/" title="Permalink to DataContractSerializer.ReadObject is easily confused.">Source</a></p>
<h1 id="datacontractserializer.readobject-is-easily-confused">DataContractSerializer.ReadObject is easily confused.</h1>
<p>With WCF services you need to declare contracts and generate contract classes that encapsulate those contracts. Most of the time you can simply let the framework deal with whatever it needs to do to deal with these objects. Sometimes, you need to actually see without running a service what XML would result from a contract object or serialize a contract object from XML text.</p>
<p>In .NET 3.5 there exists the System.Runtime.Serialization.DataContractSerializer class that perform serialization of data contracts.</p>
<p>Based on its documentation it seems fairly simple to create data contract object to/from XML methods. For example:</p>
<p>public static T XmlToContractObject<T>(string xml) where T : class, IExtensibleDataObject</p>
<p>{</p>
<p>MemoryStream memoryStream = new MemoryStream(Encoding.Unicode.GetBytes(xml));</p>
<p>using (</p>
<p>XmlDictionaryReader reader = XmlDictionaryReader.CreateTextReader(memoryStream, Encoding.Unicode,</p>
<p>new XmlDictionaryReaderQuotas(), null))</p>
<p>{</p>
<p>DataContractSerializer dataContractSerializer = new DataContractSerializer(typeof(T));</p>
<p>return dataContractSerializer.ReadObject(reader) as T;</p>
<p>}</p>
<p>}</p>
<p>public static string ContractObjectToXml<T>(T obj) where T : IExtensibleDataObject</p>
<p>{</p>
<p>DataContractSerializer dataContractSerializer = new DataContractSerializer(obj.GetType());</p>
<p>String text;</p>
<p>using (MemoryStream memoryStream = new MemoryStream())</p>
<p>{</p>
<p>dataContractSerializer.WriteObject(memoryStream, obj);</p>
<p>text = Encoding.UTF8.GetString(memoryStream.GetBuffer());</p>
<p>}</p>
<p>return text;</p>
<p>}</p>
<p>But, when you try to perform a round-trip from a contract object to XML and back you'll notice that you get SerializationException with the cryptic message of &quot;There was an error deserializing the object of type <sometype>. The data at the root level is invalid&quot;, despite that the XML seems view when examined.</p>
<p>When Encoding.UTF8.GetString is called, it literally translates the entire array into a String object. This means that it reads any and all 0 bytes in the array and dumps out null characters (&quot;) into the string. Why do I mention this? Well, MemoryStream uses a self-expanding buffer to write to. When MemoryStream runs out of space in its buffer, it doubles the size of the buffer, zeroes it out, then copies the original buffer to the start of the new buffer. When MemoryStream.GetBuffer is called it simply gets a reference to this buffer, regardless of how many bytes have been written to the stream. So, most of the time you get a buffer with zeroes padded to the end of it.</p>
<p>If you look closely at the resulting XML, there are a bunch of &quot; characters at the end of the string.</p>
<p>As it turns out, DataContractSerializer.ReadObject (or something it calls) doesn't like all the extra null characters and this is the cause of the SerializationException.</p>
<p>Irritating as this may be, the fix is fairly straightforward. Simply, create a new buffer equal to the length of the stream and copy the data from the MemoryStream buffer to the new one–trimming all the extra zeroes. For example:</p>
<p>public static string ContractObjectToXml<T>(T obj) where T : IExtensibleDataObject</p>
<p>{</p>
<p>DataContractSerializer dataContractSerializer = new DataContractSerializer(obj.GetType());</p>
<p>String text;</p>
<p>using (MemoryStream memoryStream = new MemoryStream())</p>
<p>{</p>
<p>dataContractSerializer.WriteObject(memoryStream, obj);</p>
<p>** byte[] data = new byte[memoryStream.Length];**</p>
<p>** Array.Copy(memoryStream.GetBuffer(), data, data.Length);**</p>
<p>text = Encoding.UTF8.GetString(data);</p>
<p>}</p>
<p>return text;</p>
<p>}</p>


<div id="disqus_thread"></div>  
<!--
    'DataContractSerializer.ReadObject-is-easily-confused.'
    'DataContractSerializer.ReadObject is easily confused.'
    'http://blog.peterritchie.com/posts/DataContractSerializer.ReadObject-is-easily-confused.'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('4/29/09');
    console.info('DataContractSerializer.ReadObject-is-easily-confused.');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'DataContractSerializer.ReadObject is easily confused.';
    var disqus_url = 'http://blog.peterritchie.com/posts/DataContractSerializer.ReadObject-is-easily-confused.';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'DataContractSerializer.ReadObject-is-easily-confused.';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2025
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>&nbsp;|<a rel="me" href="https://bsky.app/profile/peterritchie.com">Bluesky</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

