
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - Performance Implications of try/catch/finally, Part Two</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - Performance Implications of try/catch/finally, Part Two" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/Performance-Implications-of-try%2Fcatch%2Ffinally%2C-Part-Two" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/testing">Testing</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Performance Implications of try/catch/finally, Part Two</h1>
    <div class="meta">        
Published on Thursday, July 12, 2007<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/NET-20" class="btn btn-default btn-xs">.NET 2.0</a>
                    <a role="button" href="/tags/NET-Development" class="btn btn-default btn-xs">.NET Development</a>
                    <a role="button" href="/tags/C%23" class="btn btn-default btn-xs">C#</a>
                    <a role="button" href="/tags/Design/Coding-Guidance" class="btn btn-default btn-xs">Design/Coding Guidance</a>
                    <a role="button" href="/tags/July-2007" class="btn btn-default btn-xs">July 2007</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://blogs.msmvps.com/peterritchie/2007/07/12/performance-implications-of-try-catch-finally-part-two/" title="Permalink to Performance Implications of try/catch/finally, Part Two">Source</a></p>
<h1 id="performance-implications-of-trycatchfinally-part-two">Performance Implications of try/catch/finally, Part Two</h1>
<p>In a previous blog entry <a href="http://msmvps.com/blogs/peterritchie/archive/2007/06/22/performance-implications-of-try-catch-finally.aspx">Performance Implications of try/catch/finally</a>I outlined that the conventional wisdom that there are no performance implications to try blocks unless an exception is thrown is false. I have some clarifications and details to add.</p>
<p>My original tests used academic sample code like this:</p>
<p>public int Method( )</p>
<p>{</p>
<p>int i = 10;</p>
<p>try</p>
<p>{</p>
<pre><code>i = 20;

i = 30;
</code></pre>
<p>Thread.Sleep(i);</p>
<p>}</p>
<p>finally</p>
<p>{</p>
<pre><code>Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>return i;</p>
<p>}</p>
<p>Aswritten, theoptimized instructions generated by the JIT (Just-In-Time compiler) was showing that no optimizations were occurring in the try blockin that the only obvious optimization–the assignment of_20_ to _i–_wasn't optimizedaway.</p>
<p>But,I've loaded-the-deck, so to speak.Let's consider what exception handling needs to be able to do. In this case,I've explicitly said I need to do something in the event of an exception in the block of code I've wrapped withtry.The JIT takes me at my word and assumes every line inthat block couldthrow an exception. In order for thefinally block to getaccuratevalues for the current state–in the event ofthat exception–it can't optimizeany variables that are used in or past the finally block.In this case <em>10</em> must first be assigned to <em>i</em>, then <em>20</em> must be assigned to <em>i</em> then <em>30</em> must be assigned to <em>i</em> in the sequence specified in the source code; because if those assignments threw an exception, the finally block would need one of the values: <em>10</em>, <em>20</em>, or <em>30</em>.</p>
<p>As you might be able to tell, I've loaded-the-deck because I don't have much outside the try block and everything in the try block is used outside of it as well. I haven't given the JIT much to work with. So, the &quot;no optimizations are performed in try blocks&quot; isn't entirely accurate. Obviously, in this case, the assignment of <em>10</em> to <em>i</em> wasn't optimized as well. But, the JIT <em>is</em> smart enough to attempt to optimize within the try block. If we change the sample slightly to this:</p>
<p>public int Method( )</p>
<p>{</p>
<p>int i = 10;</p>
<p>try</p>
<p>{</p>
<p>**    int c = 2;**</p>
<p>**    c = 3;**</p>
<p>i = 20;</p>
<pre><code>i = 30;
</code></pre>
<p>** Thread.Sleep(c);**</p>
<p>}</p>
<p>finally</p>
<p>{</p>
<pre><code>Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>return i;</p>
<p>}</p>
<p>…the JIT knows that <em>c</em> is not used outside thetry block and proceeds to optimize it away and converts the Sleep statement into <em>Sleep(3)</em>. Essentially it's if I had written:</p>
<p>public int Method( )</p>
<p>{</p>
<p>int i = 10;</p>
<p>try</p>
<p>{</p>
<pre><code>i = 20;

i = 30;

Thread.Sleep(3);
</code></pre>
<p>}</p>
<p>finally</p>
<p>{</p>
<pre><code>Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>return i;</p>
<p>}</p>
<p>Okay, things aren't that dire; at least the JIT is doing what it can within the try block. But what about outside the try block; how drastic are the lack of optimizations there? Again, the JIT is smart enough to do what it can. If we change our original sample slightly again:</p>
<p>public int Method( )</p>
<p>{</p>
<p>int i = 10;</p>
<p>**   int b = 9;**</p>
<p>**   b = 7;**</p>
<p>try</p>
<p>{</p>
<pre><code>i = 20;

i = 30;

Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>finally</p>
<p>{</p>
<pre><code>Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>**   return b;**</p>
<p>}</p>
<p>We see that the JITis smart enough toattempt to optimize what'soutside the try block, and essentially results in this:</p>
<p>public int Method( )</p>
<p>{</p>
<p>int i = 10;</p>
<p>int b = 7;</p>
<p>try</p>
<p>{</p>
<pre><code>i = 20;

i = 30;

Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>finally</p>
<p>{</p>
<pre><code>Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>return b;</p>
<p>}</p>
<p>Better, it'scoalesced the writes (<em>7</em> and <em>9</em>)to b into a single write (<em>7</em>);butfor some reason itstill forces the assignment of <em>7</em> to <em>b</em> before the try block. There's nothing that could see <em>b</em> until the return, so it should be able to optimize it a bit further to this:</p>
<p>public int Method( )</p>
<p>{</p>
<p>int i = 10;</p>
<p>try</p>
<p>{</p>
<pre><code>i = 20;

i = 30;

Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>finally</p>
<p>{</p>
<pre><code>Thread.Sleep(i);
</code></pre>
<p>}</p>
<p>return 7;</p>
<p>}</p>
<p>So, while my previous statement wasn'tentirely accurate, I think what the JIT can optimize isneither better nor worse than &quot;no optimizations are performed in try blocks&quot;, just different.You should still pay close attention to what you're doing in and around try blocks.</p>
<p>Also, an apples-to-oranges comparison; but methods with try/catch/finally blocks won't be inlined.</p>
<p>Having described what the JIT appears to be doing, and the implication that optimizations to variables used before and after will result in only coalesce-ations prior to the try block (i.e. we've observed that it won't optimize away a variable declared before a try block that is not used within the try or the finally); you should not rely on those side-effects. As far a I'm concerned the JIT is free to perform that last optimization I described, and probably many others.</p>


<div id="disqus_thread"></div>  
<!--
    'Performance-Implications-of-try%2Fcatch%2Ffinally%2C-Part-Two'
    'Performance Implications of try/catch/finally, Part Two'
    'http://blog.peterritchie.com/posts/Performance-Implications-of-try%2Fcatch%2Ffinally%2C-Part-Two'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('7/12/07');
    console.info('Performance-Implications-of-try%2Fcatch%2Ffinally%2C-Part-Two');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'Performance Implications of try/catch/finally, Part Two';
    var disqus_url = 'http://blog.peterritchie.com/posts/Performance-Implications-of-try%2Fcatch%2Ffinally%2C-Part-Two';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'Performance-Implications-of-try%2Fcatch%2Ffinally%2C-Part-Two';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2025
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>&nbsp;|&nbsp;<a rel="me" href="https://bsky.app/profile/peterritchie.com">Bluesky</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

