
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Peter Ritchie&#x27;s Blog - More on Async Functions</title>
        <meta name="description" content="Peter Ritchie" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.xml" />
                <link type="application/atom+xml" rel="alternate" title="Peter Ritchie&#x27;s Blog" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-tooltip" content="Peter Ritchie&#x27;s Blog" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Peter Ritchie&#x27;s Blog - More on Async Functions" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.peterritchie.com/posts/More-on-Async-Functions" />
        <!-- TODO: More social graph meta tags -->

        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Peter Ritchie&#x27;s Blog</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>More on Async Functions</h1>
    <div class="meta">        
Published on Friday, October 29, 2010<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/Async-Functions" class="btn btn-default btn-xs">Async Functions</a>
                    <a role="button" href="/tags/C%23" class="btn btn-default btn-xs">C#</a>
                    <a role="button" href="/tags/C%23-5" class="btn btn-default btn-xs">C# 5</a>
                    <a role="button" href="/tags/DevCenterPost" class="btn btn-default btn-xs">DevCenterPost</a>
                    <a role="button" href="/tags/October-2010" class="btn btn-default btn-xs">October 2010</a>
                    <a role="button" href="/tags/Visual-Studio-vNext" class="btn btn-default btn-xs">Visual Studio vNext</a>
                    <a role="button" href="/tags/msmvps" class="btn btn-default btn-xs">msmvps</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p><a href="http://blogs.msmvps.com/peterritchie/2010/10/29/more-on-async-functions/" title="Permalink to More on Async Functions">Source</a></p>
<h1 id="more-on-async-functions">More on Async Functions</h1>
<p>In my last post I showed .Net 1.1 and .NET 2.0 code that performed some asychronous operations. I then showed the new syntax with &quot;async&quot; and &quot;await&quot; that did the same thing.</p>
<p>But, I didn't detail what's really going on in the new syntax.</p>
<p>If you want to know more about the details of what's going on, read on. If you just trust me about the previous code, you don't have to read on 🙂</p>
<p>When the Click handler is executed it basically executes everything up to the first await and returns. This allows the UI to be responsive. The compiler generates some code that takes the <code>Task&lt;T&gt;</code> object that is returned from the async method and waits for it. If there is code that needs to execute after the await, then the compiler effectively generates a continuation. With regard to <code>Task&lt;T&gt;</code>, that's basically a call to <code>Task&lt;T&gt;</code>.ContinueWith. Any other await statements are collected in that continuation and the same thing is done, the continuation is executed up to the first await and returns…</p>
<p>The underlying architecture knows about synchronization contexts and makes sure &quot;synchronous&quot; code within the Click handler is executed on the UI thread. So, as you saw in the example, we didn't have to manually deal with marshaling back to the UI thread via Control.Invoke().</p>
<p>My original example was overly simplistic and didn't include anything to deal with disposal. To a certain extent I've done async functions a disservice because async functions make disposal much, much easier. For example, my .NET 4.0 code would do something like this:</p>
<p>private void button_Click(object sender, EventArgs e)<br />
{<br />
button.Enabled = false;<br />
var webRequest = WebRequest.Create(&quot;<a href="http://google.ca">http://google.ca</a>&quot;);<br />
webRequest.BeginGetResponse(asyncResult =&gt;<br />
{<br />
var response = webRequest.EndGetResponse(asyncResult);<br />
var stream = response.GetResponseStream();<br />
if (stream != null)<br />
{<br />
var reader = new StreamReader(stream);<br />
var text = reader.ReadToEnd();<br />
BeginInvoke((MethodInvoker) (() =&gt;<br />
{<br />
textBox.Text = text;<br />
button.Enabled = true;<br />
reader.Dispose();<br />
stream.Dispose();<br />
((IDisposable) response).Dispose();<br />
}));<br />
}<br />
else<br />
{<br />
((IDisposable)response).Dispose();<br />
}<br />
}, null);<br />
}</p>
<p>As you can see, we can't use the using statement because that assumes the block in which using block resides is run asynchronously, so we're forced to manually call Dispose (and in the case of WebResponse, cast to IDisposable first because it explicitly implements IDisposable).</p>
<p>With await, we can write a block of code with bits of it being asynchronous and still use using statements. So, with async functions, our code can now dispose more cleanly; for example:</p>
<p>private async void button1_Click(object sender, EventArgs e)<br />
{<br />
try<br />
{<br />
button.Enabled = false;<br />
var webRequest = WebRequest.Create(&quot;<a href="http://google.ca">http://google.ca</a>&quot;);<br />
using (var response = await webRequest.GetResponseAsync())<br />
using (var stream = response.GetResponseStream())<br />
{<br />
if (stream == null) return;<br />
using (var reader = new StreamReader(stream))<br />
{<br />
textBox.Text = await reader.ReadToEndAsync();<br />
}<br />
}<br />
}<br />
finally<br />
<br />
}</p>
<p>C# 3and lambda expressions make the act of using asynchronous methods much easier than .NET 1.x; the next version of C# with async functions takes it that final step forward.</p>


<div id="disqus_thread"></div>  
<!--
    'More-on-Async-Functions'
    'More on Async Functions'
    'http://blog.peterritchie.com/posts/More-on-Async-Functions'
-->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    var fromJekyllDate = new Date('Wed Feb 01 2022');
    var publishedDate = new Date('10/29/10');
    console.info('More-on-Async-Functions');

    var disqus_identifier = '';
    var disqus_shortname = 'peterritchiesblog'; // required: replace example with your forum shortname
    var disqus_title = 'More on Async Functions';
    var disqus_url = 'http://blog.peterritchie.com/posts/More-on-Async-Functions';

    if(publishedDate < fromJekyllDate)
    {
        disqus_url = disqus_url.replace('/posts', '');
        disqus_url = disqus_url + '/';
    }
    else
    {
        //var disqus_identifier = 'More-on-Async-Functions';
    }
    console.info(disqus_identifier);

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © Peter Ritchie&#x27;s Blog 2025
                        <br />
                            <a href="/feed.xml"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by "Wyam"</a></strong>
                        <br/>
                        <a rel="me" href="https://mastodon.social/@peterritchie">Mastodon.social</a>&nbsp;|&nbsp;<a rel="me" href="https://fosstodon.org/@peterritchie">fosstodon.org</a>&nbsp;|&nbsp;<a rel="me" href="https://twitter.com/peterritchie">Twitter</a>&nbsp;|&nbsp;<a rel="me" href="https://www.linkedin.com/in/peteraritchie/">LinkedIn</a>&nbsp;|&nbsp;<a rel="me" href="https://bsky.app/profile/peterritchie.com">Bluesky</a>
                    </p>
                </div>
        </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

